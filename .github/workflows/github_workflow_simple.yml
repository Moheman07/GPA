name: Gold Market Analysis (unified)

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [ main, master ]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Repo debug - list files
        run: |
          echo "PWD: $(pwd)"
          ls -la
          echo "Worktree:"
          ls -R

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install pip deps (use requirements_simple.txt)
        run: |
          python -m pip install --upgrade pip
          if [ ! -f requirements_simple.txt ]; then
            echo "requirements_simple.txt not found, creating default..."
            cat > requirements_simple.txt <<'REQ'
yfinance>=0.2.18
pandas>=2.0.0
numpy>=1.24.0
matplotlib>=3.7.0
seaborn>=0.12.0
plotly>=5.15.0
scipy>=1.10.0
statsmodels>=0.14.0
ta>=0.10.2
pandas-ta>=0.3.14b
scikit-learn>=1.3.0
requests>=2.28.0
REQ
          fi
          pip install -r requirements_simple.txt

      - name: Show python env
        run: |
          python -V
          pip -V
          python -c "import sys, os; print('cwd files:', os.listdir('.'))"

      - name: Run analysis (pick the right script)
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: |
          set -e
          CAND=("gold_analyzer_unified_full.py" "gold_analyzer_full.py" "gold_analyzer_advanced.py" "gold_analyzer_enhancements.py")
          FOUND=""
          for f in "${CAND[@]}"; do
            if [ -f "$f" ]; then
              FOUND="$f"
              break
            fi
          done
          if [ -z "$FOUND" ]; then
            echo "No analysis script found. Listing repo:" >&2
            ls -la
            exit 2
          fi
          echo "Running: $FOUND"
          python "$FOUND"

      - name: List produced JSON files
        run: |
          echo "Produced files:"
          ls -la *.json || true

      - name: Upload analysis artifact
        uses: actions/upload-artifact@v4
        with:
          name: gold-analysis-results
          path: |
            gold_analysis_unified_full.json
            gold_analysis_advanced_v6.json
            gold_analysis_enhancements.json

      - name: Commit & push JSON results (best-effort)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add gold_analysis_unified_full.json || echo "no unified json"
          git add gold_analysis_advanced_v6.json || echo "no advanced json"
          git add gold_analysis_enhancements.json || echo "no enhancements json"
          git commit -m "Update analysis results - $(date -u)" || echo "no changes to commit"
          git pull --rebase origin main || true
          git push origin main || echo "push failed or not permitted"
