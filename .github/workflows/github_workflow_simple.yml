name: Gold Analysis Advanced V6.0 - Auto-Commit

on:
  schedule:
    - cron: '0 */4 * * *'  # ÙƒÙ„ 4 Ø³Ø§Ø¹Ø§Øª
  workflow_dispatch:  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  push:
    branches: [ main ]

jobs:
  analyze-gold:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas numpy scikit-learn xgboost
        pip install textblob spacy backtrader aiohttp requests
        pip install plotly seaborn matplotlib scipy statsmodels
        python -m spacy download en_core_web_sm
        
    - name: Create main analyzer script
      run: |
        cat > gold_analyzer_advanced.py << 'EOF'
#!/usr/bin/env python3
"""
Ù…Ø­Ù„Ù„ Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 6.0
Ù†Ø³Ø®Ø© Ù‚ÙˆÙŠØ© Ø¬Ø¯Ø§Ù‹ Ù…Ø¹ Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
"""

import yfinance as yf
import pandas as pd
import numpy as np
import json
import os
from datetime import datetime, timedelta
import warnings

warnings.filterwarnings('ignore')

class AdvancedGoldAnalyzerV6:
    """Ù…Ø­Ù„Ù„ Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± 6.0"""
    
    def __init__(self):
        self.symbols = {
            'gold': 'GC=F', 'gold_etf': 'GLD', 'dxy': 'DX-Y.NYB',
            'vix': '^VIX', 'treasury': '^TNX', 'oil': 'CL=F',
            'spy': 'SPY', 'usdeur': 'EURUSD=X', 'silver': 'SI=F'
        }
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
        self.overbought_threshold = 70
        self.oversold_threshold = 30
        self.extreme_overbought = 80
        self.extreme_oversold = 20
    
    def fetch_advanced_data(self):
        """Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"""
        print("ğŸ“Š Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©...")
        try:
            # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            daily_data = yf.download(self.symbols['gold'], 
                                    period="2y", interval="1d", 
                                    progress=False)
            
            if daily_data.empty: 
                raise ValueError("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            
            return daily_data
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
            return None
    
    def calculate_advanced_indicators(self, data):
        """Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©"""
        print("ğŸ“Š Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©...")
        try:
            df = data.copy()
            
            # Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
            df['SMA_10'] = df['Close'].rolling(window=10).mean()
            df['SMA_20'] = df['Close'].rolling(window=20).mean()
            df['SMA_50'] = df['Close'].rolling(window=50).mean()
            df['SMA_200'] = df['Close'].rolling(window=200).mean()
            
            # EMA
            df['EMA_9'] = df['Close'].ewm(span=9).mean()
            df['EMA_21'] = df['Close'].ewm(span=21).mean()
            
            # RSI
            delta = df['Close'].diff()
            gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
            loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
            rs = gain / loss
            df['RSI'] = 100 - (100 / (1 + rs))
            
            # MACD
            exp1 = df['Close'].ewm(span=12).mean()
            exp2 = df['Close'].ewm(span=26).mean()
            df['MACD'] = exp1 - exp2
            df['MACD_Signal'] = df['MACD'].ewm(span=9).mean()
            df['MACD_Histogram'] = df['MACD'] - df['MACD_Signal']
            
            # Bollinger Bands
            df['BB_Middle'] = df['Close'].rolling(window=20).mean()
            bb_std = df['Close'].rolling(window=20).std()
            df['BB_Upper'] = df['BB_Middle'] + (bb_std * 2)
            df['BB_Lower'] = df['BB_Middle'] - (bb_std * 2)
            df['BB_Position'] = (df['Close'] - df['BB_Lower']) / (df['BB_Upper'] - df['BB_Lower'])
            
            # Stochastic
            low_min = df['Low'].rolling(window=14).min()
            high_max = df['High'].rolling(window=14).max()
            df['Stoch_K'] = 100 * ((df['Close'] - low_min) / (high_max - low_min))
            df['Stoch_D'] = df['Stoch_K'].rolling(window=3).mean()
            
            # Williams %R
            df['Williams_R'] = -100 * ((high_max - df['Close']) / (high_max - low_min))
            
            # ATR
            high_low = df['High'] - df['Low']
            high_close = np.abs(df['High'] - df['Close'].shift())
            low_close = np.abs(df['Low'] - df['Close'].shift())
            ranges = pd.concat([high_low, high_close, low_close], axis=1)
            true_range = np.max(ranges, axis=1)
            df['ATR'] = true_range.rolling(window=14).mean()
            
            # Volume indicators
            df['Volume_SMA'] = df['Volume'].rolling(window=20).mean()
            df['Volume_Ratio'] = df['Volume'] / df['Volume_SMA']
            
            return df.dropna()
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª: {e}")
            return data
    
    def analyze_market_sentiment(self, data):
        """ØªØ­Ù„ÙŠÙ„ Ù…Ø´Ø§Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…"""
        print("ğŸ˜Š ØªØ­Ù„ÙŠÙ„ Ù…Ø´Ø§Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚...")
        try:
            latest = data.iloc[-1]
            
            sentiment_score = 0
            sentiment_factors = []
            
            # RSI Sentiment
            rsi = latest.get('RSI', 50)
            if rsi > 70:
                sentiment_score -= 2
                sentiment_factors.append(f"RSI ØªØ´Ø¨Ø¹ ({rsi:.1f})")
            elif rsi < 30:
                sentiment_score += 2
                sentiment_factors.append(f"RSI Ø°Ø±ÙˆØ© Ø¨ÙŠØ¹ ({rsi:.1f})")
            
            # MACD Sentiment
            macd = latest.get('MACD', 0)
            macd_signal = latest.get('MACD_Signal', 0)
            if macd > macd_signal:
                sentiment_score += 1
                sentiment_factors.append("MACD Ø¥ÙŠØ¬Ø§Ø¨ÙŠ")
            else:
                sentiment_score -= 1
                sentiment_factors.append("MACD Ø³Ù„Ø¨ÙŠ")
            
            # Bollinger Bands Sentiment
            bb_position = latest.get('BB_Position', 0.5)
            if bb_position > 1.0:
                sentiment_score -= 1
                sentiment_factors.append("ÙÙˆÙ‚ Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ")
            elif bb_position < 0.0:
                sentiment_score += 1
                sentiment_factors.append("ØªØ­Øª Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø§Ù„Ø³ÙÙ„ÙŠ")
            
            # Stochastic Sentiment
            stoch_k = latest.get('Stoch_K', 50)
            stoch_d = latest.get('Stoch_D', 50)
            if stoch_k > 80 and stoch_d > 80:
                sentiment_score -= 1
                sentiment_factors.append("Stochastic ØªØ´Ø¨Ø¹")
            elif stoch_k < 20 and stoch_d < 20:
                sentiment_score += 1
                sentiment_factors.append("Stochastic Ø°Ø±ÙˆØ© Ø¨ÙŠØ¹")
            
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±
            if sentiment_score >= 3:
                sentiment = "Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ù‚ÙˆÙŠ"
            elif sentiment_score >= 1:
                sentiment = "Ø¥ÙŠØ¬Ø§Ø¨ÙŠ"
            elif sentiment_score <= -3:
                sentiment = "Ø³Ù„Ø¨ÙŠ Ù‚ÙˆÙŠ"
            elif sentiment_score <= -1:
                sentiment = "Ø³Ù„Ø¨ÙŠ"
            else:
                sentiment = "Ù…Ø­Ø§ÙŠØ¯"
            
            return {
                'score': sentiment_score,
                'sentiment': sentiment,
                'factors': sentiment_factors,
                'confidence': abs(sentiment_score) / 4
            }
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±: {e}")
            return {'score': 0, 'sentiment': 'Ù…Ø­Ø§ÙŠØ¯', 'factors': [], 'confidence': 0}
    
    def calculate_advanced_risk_metrics(self, data):
        """Ø­Ø³Ø§Ø¨ Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©"""
        print("âš ï¸ Ø­Ø³Ø§Ø¨ Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©...")
        try:
            latest = data.iloc[-1]
            
            # Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ°Ø¨Ø°Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
            returns = data['Close'].pct_change().dropna()
            volatility = returns.std() * np.sqrt(252)
            
            # Ø­Ø³Ø§Ø¨ Value at Risk (VaR)
            var_95 = np.percentile(returns, 5)
            
            # Ø­Ø³Ø§Ø¨ Maximum Drawdown
            cumulative_returns = (1 + returns).cumprod()
            running_max = cumulative_returns.expanding().max()
            drawdown = (cumulative_returns - running_max) / running_max
            max_drawdown = drawdown.min()
            
            # Ø­Ø³Ø§Ø¨ Sharpe Ratio
            risk_free_rate = 0.02
            excess_returns = returns - risk_free_rate/252
            sharpe_ratio = excess_returns.mean() / returns.std() * np.sqrt(252)
            
            return {
                'volatility': volatility,
                'var_95': var_95,
                'max_drawdown': max_drawdown,
                'sharpe_ratio': sharpe_ratio,
                'current_risk_level': self._calculate_current_risk_level(volatility, var_95, latest)
            }
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…Ø®Ø§Ø·Ø±: {e}")
            return {}
    
    def _calculate_current_risk_level(self, volatility, var_95, latest):
        """Ø­Ø³Ø§Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ"""
        try:
            risk_score = 0
            
            if volatility > 0.3:
                risk_score += 3
            elif volatility > 0.2:
                risk_score += 2
            elif volatility > 0.15:
                risk_score += 1
            
            if var_95 < -0.05:
                risk_score += 2
            elif var_95 < -0.03:
                risk_score += 1
            
            rsi = latest.get('RSI', 50)
            if rsi > 80:
                risk_score += 2
            elif rsi > 70:
                risk_score += 1
            
            bb_position = latest.get('BB_Position', 0.5)
            if bb_position > 1.0:
                risk_score += 1
            
            if risk_score >= 5:
                return "Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹"
            elif risk_score >= 3:
                return "Ø¹Ø§Ù„ÙŠ"
            elif risk_score >= 1:
                return "Ù…ØªÙˆØ³Ø·"
            else:
                return "Ù…Ù†Ø®ÙØ¶"
        except:
            return "Ù…ØªÙˆØ³Ø·"
    
    def generate_advanced_signals_v6(self, data, sentiment, risk_metrics):
        """ØªÙˆÙ„ÙŠØ¯ Ø¥Ø´Ø§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© V6"""
        print("ğŸ¯ ØªÙˆÙ„ÙŠØ¯ Ø¥Ø´Ø§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© V6...")
        
        try:
            latest = data.iloc[-1]
            current_price = latest['Close']
            
            # ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„
            technical_analysis = self._analyze_technical_indicators(latest)
            sentiment_analysis = self._analyze_sentiment(sentiment)
            risk_analysis = self._analyze_risk(risk_metrics)
            
            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
            total_score = (
                technical_analysis['score'] * 0.5 +
                sentiment_analysis['score'] * 0.3 +
                risk_analysis['score'] * 0.2
            )
            
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
            if total_score >= 2:
                signal = "Strong Buy"
                confidence = "Very High"
                action = "Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠ - ÙØ±ØµØ© Ù…Ù…ØªØ§Ø²Ø©"
            elif total_score >= 1:
                signal = "Buy"
                confidence = "High"
                action = "Ø´Ø±Ø§Ø¡ - ÙØ±ØµØ© Ø¬ÙŠØ¯Ø©"
            elif total_score <= -2:
                signal = "Strong Sell"
                confidence = "Very High"
                action = "Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ - Ø®Ø·Ø± ÙƒØ¨ÙŠØ±"
            elif total_score <= -1:
                signal = "Sell"
                confidence = "High"
                action = "Ø¨ÙŠØ¹ - Ø®Ø·Ø± ÙˆØ§Ø¶Ø­"
            else:
                signal = "Hold"
                confidence = "Low"
                action = "Ø§Ù†ØªØ¸Ø§Ø± - Ø¹Ø¯Ù… ÙˆØ¶ÙˆØ­"
            
            # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            risk_management = self._generate_advanced_risk_management(
                current_price, risk_metrics, technical_analysis
            )
            
            return {
                'signal': signal,
                'confidence': confidence,
                'action': action,
                'current_price': round(current_price, 2),
                'total_score': round(total_score, 2),
                'technical_analysis': technical_analysis,
                'sentiment_analysis': sentiment_analysis,
                'risk_analysis': risk_analysis,
                'risk_management': risk_management,
                'advanced_metrics': {
                    'volatility': risk_metrics.get('volatility', 0),
                    'sharpe_ratio': risk_metrics.get('sharpe_ratio', 0),
                    'max_drawdown': risk_metrics.get('max_drawdown', 0)
                }
            }
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª: {e}")
            return {
                'signal': 'Hold',
                'confidence': 'Low',
                'action': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„',
                'error': str(e)
            }
    
    def _analyze_technical_indicators(self, latest):
        """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ©"""
        score = 0
        analysis = []
        
        # RSI
        rsi = latest.get('RSI', 50)
        if rsi < 30:
            score += 2
            analysis.append(f"RSI Ø°Ø±ÙˆØ© Ø¨ÙŠØ¹ ({rsi:.1f})")
        elif rsi > 70:
            score -= 2
            analysis.append(f"RSI ØªØ´Ø¨Ø¹ ({rsi:.1f})")
        
        # MACD
        macd = latest.get('MACD', 0)
        macd_signal = latest.get('MACD_Signal', 0)
        if macd > macd_signal:
            score += 1
            analysis.append("MACD Ø¥ÙŠØ¬Ø§Ø¨ÙŠ")
        else:
            score -= 1
            analysis.append("MACD Ø³Ù„Ø¨ÙŠ")
        
        # Bollinger Bands
        bb_position = latest.get('BB_Position', 0.5)
        if bb_position < 0.2:
            score += 1
            analysis.append("Ù‚Ø±Ø¨ Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø§Ù„Ø³ÙÙ„ÙŠ")
        elif bb_position > 0.8:
            score -= 1
            analysis.append("Ù‚Ø±Ø¨ Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ")
        
        return {'score': score, 'analysis': analysis}
    
    def _analyze_sentiment(self, sentiment):
        """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±"""
        score = sentiment.get('score', 0)
        analysis = sentiment.get('factors', [])
        
        return {'score': score, 'analysis': analysis}
    
    def _analyze_risk(self, risk_metrics):
        """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±"""
        score = 0
        analysis = []
        
        risk_level = risk_metrics.get('current_risk_level', 'Ù…ØªÙˆØ³Ø·')
        if risk_level == 'Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹':
            score -= 2
            analysis.append("Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹")
        elif risk_level == 'Ø¹Ø§Ù„ÙŠ':
            score -= 1
            analysis.append("Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ©")
        elif risk_level == 'Ù…Ù†Ø®ÙØ¶':
            score += 1
            analysis.append("Ù…Ø®Ø§Ø·Ø± Ù…Ù†Ø®ÙØ¶Ø©")
        
        return {'score': score, 'analysis': analysis}
    
    def _generate_advanced_risk_management(self, current_price, risk_metrics, technical_analysis):
        """ØªÙˆÙ„ÙŠØ¯ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø§Ø·Ø± Ù…ØªÙ‚Ø¯Ù…Ø©"""
        try:
            volatility = risk_metrics.get('volatility', 0.2)
            atr = current_price * volatility / np.sqrt(252)
            
            # Ø­Ø³Ø§Ø¨ Ù…Ø³ØªÙˆÙŠØ§Øª ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            stop_loss_levels = {
                'ultra_tight': round(current_price - (atr * 1), 2),
                'tight': round(current_price - (atr * 1.5), 2),
                'conservative': round(current_price - (atr * 2), 2),
                'moderate': round(current_price - (atr * 2.5), 2),
                'wide': round(current_price - (atr * 3), 2)
            }
            
            # Ø­Ø³Ø§Ø¨ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            profit_targets = {
                'target_1': round(current_price + (atr * 2), 2),
                'target_2': round(current_price + (atr * 3), 2),
                'target_3': round(current_price + (atr * 4), 2),
                'target_4': round(current_price + (atr * 5), 2)
            }
            
            # Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
            risk_level = risk_metrics.get('current_risk_level', 'Ù…ØªÙˆØ³Ø·')
            position_size = self._calculate_advanced_position_size(risk_level, technical_analysis)
            
            return {
                'stop_loss_levels': stop_loss_levels,
                'profit_targets': profit_targets,
                'position_size': position_size,
                'max_risk_per_trade': self._get_advanced_risk_percentage(risk_level),
                'risk_reward_ratio': round(3 / 2, 2),
                'volatility_adjusted': True,
                'atr_based': True
            }
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±: {e}")
            return {}
    
    def _calculate_advanced_position_size(self, risk_level, technical_analysis):
        """Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…ØªÙ‚Ø¯Ù…"""
        base_size = {
            'Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹': '1-2%',
            'Ø¹Ø§Ù„ÙŠ': '2-3%',
            'Ù…ØªÙˆØ³Ø·': '3-5%',
            'Ù…Ù†Ø®ÙØ¶': '5-10%'
        }.get(risk_level, '3-5%')
        
        technical_score = technical_analysis.get('score', 0)
        if technical_score >= 2:
            return f"{base_size} (Ù…Ø¹Ø¯Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰)"
        elif technical_score <= -2:
            return f"{base_size} (Ù…Ø¹Ø¯Ù„ Ù„Ù„Ø£Ø³ÙÙ„)"
        else:
            return base_size
    
    def _get_advanced_risk_percentage(self, risk_level):
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©"""
        risk_map = {
            'Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹': '0.5%',
            'Ø¹Ø§Ù„ÙŠ': '1%',
            'Ù…ØªÙˆØ³Ø·': '2%',
            'Ù…Ù†Ø®ÙØ¶': '3%'
        }
        return risk_map.get(risk_level, '2%')
    
    def generate_advanced_report_v6(self, analysis_result):
        """ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ù…ØªÙ‚Ø¯Ù… V6"""
        try:
            report = []
            report.append("=" * 80)
            report.append("ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø°Ù‡Ø¨ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 6.0")
            report.append("=" * 80)
            report.append(f"Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            report.append("")
            
            # Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            if 'signal' in analysis_result:
                report.append("ğŸ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:")
                report.append(f"  â€¢ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {analysis_result['signal']}")
                report.append(f"  â€¢ Ø§Ù„Ø«Ù‚Ø©: {analysis_result['confidence']}")
                report.append(f"  â€¢ Ø§Ù„ØªÙˆØµÙŠØ©: {analysis_result['action']}")
                report.append(f"  â€¢ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${analysis_result['current_price']}")
                report.append(f"  â€¢ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: {analysis_result['total_score']}")
                report.append("")
            
            # Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ
            if 'technical_analysis' in analysis_result:
                ta = analysis_result['technical_analysis']
                report.append("ğŸ“ˆ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ:")
                report.append(f"  â€¢ Ø§Ù„Ù†ØªÙŠØ¬Ø©: {ta['score']}")
                for analysis in ta['analysis']:
                    report.append(f"  â€¢ {analysis}")
                report.append("")
            
            # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±
            if 'sentiment_analysis' in analysis_result:
                sa = analysis_result['sentiment_analysis']
                if sa['analysis']:
                    report.append("ğŸ˜Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±:")
                    report.append(f"  â€¢ Ø§Ù„Ù†ØªÙŠØ¬Ø©: {sa['score']}")
                    for analysis in sa['analysis']:
                        report.append(f"  â€¢ {analysis}")
                    report.append("")
            
            # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±
            if 'risk_analysis' in analysis_result:
                ra = analysis_result['risk_analysis']
                if ra['analysis']:
                    report.append("âš ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±:")
                    report.append(f"  â€¢ Ø§Ù„Ù†ØªÙŠØ¬Ø©: {ra['score']}")
                    for analysis in ra['analysis']:
                        report.append(f"  â€¢ {analysis}")
                    report.append("")
            
            # Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            if 'advanced_metrics' in analysis_result:
                am = analysis_result['advanced_metrics']
                report.append("ğŸ“Š Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:")
                report.append(f"  â€¢ Ø§Ù„ØªØ°Ø¨Ø°Ø¨ Ø§Ù„Ø³Ù†ÙˆÙŠ: {am.get('volatility', 0):.2%}")
                report.append(f"  â€¢ Ù†Ø³Ø¨Ø© Ø´Ø§Ø±Ø¨: {am.get('sharpe_ratio', 0):.3f}")
                report.append(f"  â€¢ Ø£Ù‚ØµÙ‰ Ø§Ù†Ø®ÙØ§Ø¶: {am.get('max_drawdown', 0):.2%}")
                report.append("")
            
            # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            if 'risk_management' in analysis_result:
                rm = analysis_result['risk_management']
                report.append("âš ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:")
                report.append(f"  â€¢ Ø­Ø¬Ù… Ø§Ù„Ù…Ø±ÙƒØ²: {rm['position_size']}")
                report.append(f"  â€¢ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸: ${rm['stop_loss_levels']['conservative']}")
                report.append(f"  â€¢ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£ÙˆÙ„: ${rm['profit_targets']['target_1']}")
                report.append(f"  â€¢ Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© Ø§Ù„Ù‚ØµÙˆÙ‰: {rm['max_risk_per_trade']}")
                report.append(f"  â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©/Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: {rm['risk_reward_ratio']}")
                report.append("")
            
            report.append("=" * 80)
            report.append("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 6.0")
            report.append("ØªÙ… ØªØ·ÙˆÙŠØ±: ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… | Ù…Ø´Ø§Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ | Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø§Ø·Ø± Ø´Ø§Ù…Ù„Ø©")
            
            return "\n".join(report)
            
        except Exception as e:
            return f"Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {e}"
    
    def run_advanced_analysis_v6(self):
        """ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… V6"""
        print("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø°Ù‡Ø¨ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 6.0...")
        print("=" * 80)
        
        try:
            # 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            market_data = self.fetch_advanced_data()
            if market_data is None:
                raise ValueError("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙ‚")
            
            # 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            technical_data = self.calculate_advanced_indicators(market_data)
            
            # 3. ØªØ­Ù„ÙŠÙ„ Ù…Ø´Ø§Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚
            sentiment = self.analyze_market_sentiment(technical_data)
            
            # 4. Ø­Ø³Ø§Ø¨ Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            risk_metrics = self.calculate_advanced_risk_metrics(technical_data)
            
            # 5. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© V6
            signals = self.generate_advanced_signals_v6(technical_data, sentiment, risk_metrics)
            
            # 6. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            final_result = {
                'timestamp': datetime.now().isoformat(),
                'status': 'success',
                'version': '6.0',
                **signals
            }
            
            # 7. Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            self.save_advanced_results_v6(final_result)
            
            # 8. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            report = self.generate_advanced_report_v6(final_result)
            print(report)
            
            print("\nâœ… ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… V6.0 Ø¨Ù†Ø¬Ø§Ø­!")
            return final_result
            
        except Exception as e:
            error_message = f"âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„: {e}"
            print(error_message)
            error_result = {
                'timestamp': datetime.now().isoformat(),
                'status': 'error',
                'version': '6.0',
                'error': str(e)
            }
            self.save_advanced_results_v6(error_result)
            return error_result
    
    def save_advanced_results_v6(self, results):
        """Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ V6"""
        try:
            filename = "gold_analysis_advanced_v6.json"
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(results, f, ensure_ascii=False, indent=2, default=str)
            print(f"ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙŠ: {filename}")
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: {e}")

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    analyzer = AdvancedGoldAnalyzerV6()
    analyzer.run_advanced_analysis_v6()

if __name__ == "__main__":
    main()
EOF
        
    - name: Run advanced analysis
      run: |
        python gold_analyzer_advanced.py
        
    - name: Commit results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gold_analysis_advanced_v6.json
        git add gold_analyzer_advanced.py
        git commit -m "ğŸ“Š ØªØ­Ø¯ÙŠØ« ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… V6.0 - $(date '+%Y-%m-%d %H:%M:%S')"
        
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
