name: تحليل الذهب التلقائي

on:
  schedule:
    # تشغيل كل 6 ساعات
    - cron: '0 */6 * * *'
  
  # إمكانية التشغيل اليدوي
  workflow_dispatch:

jobs:
  analyze-gold:
    runs-on: ubuntu-latest
    
    steps:
    - name: استنساخ المستودع
      uses: actions/checkout@v4
    
    - name: إعداد Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: تثبيت المكتبات
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: تشغيل تحليل الذهب
      run: |
        python simple_gold_analyzer.py
    
    - name: رفع النتائج
      uses: actions/upload-artifact@v3
      with:
        name: gold-analysis-results
        path: |
          *.json
          *.txt
        retention-days: 30
    
    - name: إنشاء Issue مع النتائج (اختياري)
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            // البحث عن ملف التقرير الأحدث
            const files = fs.readdirSync('.');
            const reportFile = files.find(f => f.startsWith('gold_report_') && f.endsWith('.txt'));
            
            if (reportFile) {
              const report = fs.readFileSync(reportFile, 'utf8');
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `تقرير تحليل الذهب - ${new Date().toISOString().split('T')[0]}`,
                body: `## تقرير تحليل الذهب التلقائي\n\n\`\`\`\n${report}\n\`\`\`\n\n---\n*تم إنشاؤه تلقائياً بواسطة GitHub Actions*`
              });
            }
          } catch (error) {
            console.log('لم يتم العثور على تقرير أو خطأ في الإنشاء:', error.message);
          }
