name: Gold Analysis V3 Auto-Commit

on:
  schedule:
    - cron: '0 */3 * * 1-5'
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m spacy download en_core_web_sm
        
    - name: Test Basic Functionality
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        # إنشاء ملف الاختبار
        cat > test_analyzer.py << 'EOF'
        import yfinance as yf
        import os
        from datetime import datetime
        
        print("🔍 اختبار الوظائف الأساسية...")
        print("="*50)
        
        # اختبار yfinance
        print("\n1. اختبار جلب بيانات الذهب:")
        try:
            gold_data = yf.download('GC=F', period='5d', progress=False)
            if not gold_data.empty:
                print(f"✅ نجح - آخر سعر: ${gold_data['Close'].iloc[-1]:.2f}")
            else:
                print("❌ البيانات فارغة")
        except Exception as e:
            print(f"❌ خطأ: {e}")
        
        # اختبار API keys
        print("\n2. مفاتيح API:")
        print(f"NEWS_API_KEY: {'✅ موجود' if os.getenv('NEWS_API_KEY') else '❌ مفقود'}")
        print(f"FRED_API_KEY: {'✅ موجود' if os.getenv('FRED_API_KEY') else '⚠️ مفقود (اختياري)'}")
        EOF
        
        python test_analyzer.py
        
    - name: Run Analysis V3
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        # تشغيل التحليل الرئيسي
        python main_analyzer_v3.py || echo "فشل التحليل الرئيسي"
        
        # عرض محتوى الملفات الناتجة
        echo -e "\n📄 محتوى gold_analysis_summary.json:"
        cat gold_analysis_summary.json 2>/dev/null || echo "الملف غير موجود"
        
    - name: Commit and Push Results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Gold Analysis Bot V3"
        
        # إضافة الملفات
        git add gold_analysis_v3.json || true
        git add gold_analysis_summary.json || true
        git add analysis_history.db || true
        git add *.pkl || true
        
        # التحقق من وجود تغييرات
        if git diff --staged --quiet; then
          echo "لا توجد تغييرات للحفظ"
        else
          git commit -m "🔄 Update gold analysis V3 - $(date +'%Y-%m-%d %H:%M UTC')"
          git push
        fi
