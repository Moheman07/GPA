name: ๐ Enhanced Gold Analysis V3.0

on:
  schedule:
    # ุชุดุบูู ูู 4 ุณุงุนุงุช ูู ุฃููุงุช ุงูุณูู ุงููุดุทุฉ
    - cron: '0 6,10,14,18,22 * * 1-5'  # ุฃูุงู ุงูุนูู
    - cron: '0 12 * * 0,6'              # ุนุทูุฉ ููุงูุฉ ุงูุฃุณุจูุน
  
  # ุชุดุบูู ูุฏูู
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'ููุน ุงูุชุญููู'
        required: false
        default: 'full'
        type: choice
        options:
        - full
        - quick
        - ml_only

env:
  # ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงูุนุงูุฉ
  PYTHONPATH: ${{ github.workspace }}
  TZ: 'UTC'

jobs:
  enhanced-gold-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      
    steps:
    - name: ๐ฅ ุงุณุชูุณุงุฎ ุงููุณุชูุฏุน
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ๐ ุฅุนุฏุงุฏ Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: โก ุชุญุฏูุซ pip ูุชุซุจูุช ุงูููุชุจุงุช
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip list
    
    - name: ๐ง ูุญุต ุงูุจูุฆุฉ
      run: |
        echo "๐ ุงูููุทูุฉ ุงูุฒูููุฉ: $(date)"
        echo "๐ ุฅุตุฏุงุฑ Python: $(python --version)"
        echo "๐พ ูุณุงุญุฉ ุงููุฑุต: $(df -h . | tail -1)"
        echo "๐ง ุงูุฐุงูุฑุฉ: $(free -h)"
    
    - name: ๐ ุชุดุบูู ุงูุชุญููู ุงูุงุญุชุฑุงูู ุงููุญุณู
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        ANALYSIS_TYPE: ${{ github.event.inputs.analysis_type || 'full' }}
      run: |
        echo "๐ฏ ููุน ุงูุชุญููู: $ANALYSIS_TYPE"
        
        # ุชุดุบูู ุงูุณูุฑุจุช ุงููุจุณุท
        if [ -f "simple_gold_analyzer.py" ]; then
          python simple_gold_analyzer.py
        else
          echo "โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณูุฑุจุช"
          exit 1
        fi
        
        echo "โ ุชู ุฅููุงู ุงูุชุญููู"
    
    - name: ๐ ูุนุงูุฌุฉ ุงููุชุงุฆุฌ
      if: always()
      run: |
        echo "๐ ูููุงุช ุงููุชุงุฆุฌ ุงููุชุงุญุฉ:"
        ls -la *.json *.txt 2>/dev/null || echo "ูุง ุชูุฌุฏ ูููุงุช ูุชุงุฆุฌ"
        
        # ุฅูุดุงุก ููุฎุต ุณุฑูุน
        if [ -f "gold_summary_"*.json ]; then
          echo "๐ ุงูููุฎุต ุงูุณุฑูุน:"
          cat gold_summary_*.json | head -20
        fi
    
    - name: ๐พ ุฑูุน ุงููุชุงุฆุฌ ูู Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gold-analysis-results-${{ github.run_number }}
        path: |
          *.json
          *.txt
          *.pkl
          *.db
        retention-days: 30
        if-no-files-found: warn
    
    - name: ๐ข ุฅูุดุงุก Issue ูุน ุงูุชูุฑูุฑ ุงูููุตู
      if: success()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            // ุงูุจุญุซ ุนู ูููุงุช ุงูุชูุฑูุฑ
            const files = fs.readdirSync('.');
            const summaryFile = files.find(f => f.startsWith('gold_summary_') && f.endsWith('.json'));
            const analysisFile = files.find(f => f.startsWith('gold_analysis_v3_') && f.endsWith('.json'));
            
            let issueBody = `## ๐ ุชูุฑูุฑ ุงูุชุญููู ุงูุงุญุชุฑุงูู ููุฐูุจ V3.0\n\n`;
            issueBody += `**โฐ ููุช ุงูุชุญููู:** ${new Date().toISOString()}\n`;
            issueBody += `**๐ ุฑูู ุงูุชุดุบูู:** #${context.runNumber}\n`;
            issueBody += `**โ๏ธ ููุน ุงูุชุญููู:** ${process.env.ANALYSIS_TYPE || 'full'}\n\n`;
            
            // ุฅุถุงูุฉ ุงูููุฎุต ุงูุณุฑูุน
            if (summaryFile) {
              try {
                const summary = JSON.parse(fs.readFileSync(summaryFile, 'utf8'));
                issueBody += `### ๐ ุงูููุฎุต ุงูุณุฑูุน\n\n`;
                issueBody += `- **ุงูุฅุดุงุฑุฉ:** ${summary.signal || 'N/A'}\n`;
                issueBody += `- **ุงูุซูุฉ:** ${summary.confidence || 'N/A'}\n`;
                issueBody += `- **ุงูุณุนุฑ:** $${summary.price || 'N/A'}\n`;
                issueBody += `- **ุงูุชูุตูุฉ:** ${summary.recommendation || 'N/A'}\n\n`;
              } catch (e) {
                console.log('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููุฎุต:', e.message);
              }
            }
            
            // ุฅุถุงูุฉ ุฑุงุจุท ูููุชุงุฆุฌ ุงููุงููุฉ
            issueBody += `### ๐ ุงููุชุงุฆุฌ ุงููุงููุฉ\n\n`;
            issueBody += `๐ [ุชุญููู ุฌููุน ุงููุชุงุฆุฌ](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n`;
            
            // ุฅุถุงูุฉ ุชูุงุตูู ุชูููุฉ
            issueBody += `### ๐ง ุชูุงุตูู ุชูููุฉ\n\n`;
            issueBody += `- **ุงูููุชุจุงุช:** yfinance, scikit-learn, xgboost\n`;
            issueBody += `- **ุงูููุฒุงุช:** ุชุนูู ุขูู, ุชุญููู ูุชุนุฏุฏ ุงูุฃุทุฑ, ุชุญููู ุฃุฎุจุงุฑ\n`;
            issueBody += `- **ุงูุจูุฆุฉ:** GitHub Actions Ubuntu Latest\n\n`;
            
            // ุชุญุฏูุฏ ุงูุชุณููุงุช
            const labels = ['gold-analysis', 'automated'];
            if (summaryFile) {
              const summary = JSON.parse(fs.readFileSync(summaryFile, 'utf8'));
              if (summary.signal && summary.signal.includes('Buy')) {
                labels.push('bullish');
              } else if (summary.signal && summary.signal.includes('Sell')) {
                labels.push('bearish');
              }
            }
            
            issueBody += `---\n*๐ค ุชู ุฅูุดุงุคู ุชููุงุฆูุงู ุจูุงุณุทุฉ Enhanced Gold Analyzer V3.0*`;
            
            // ุฅูุดุงุก Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `๐ ุชุญููู ุงูุฐูุจ V3.0 - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: labels
            });
            
            console.log('โ ุชู ุฅูุดุงุก Issue ุจูุฌุงุญ');
            
          } catch (error) {
            console.log('โ๏ธ ุฎุทุฃ ูู ุฅูุดุงุก Issue:', error.message);
            
            // ุฅูุดุงุก issue ูุจุณุท ูู ุญุงูุฉ ุงูุฎุทุฃ
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `โ๏ธ ุชุญููู ุงูุฐูุจ - ${new Date().toISOString().split('T')[0]}`,
              body: `## ุชุญููู ุงูุฐูุจ ุงูุงุญุชุฑุงูู\n\nโ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงููุชุงุฆุฌ\n\n**ุงูุฎุทุฃ:** ${error.message}\n\n๐ [ุนุฑุถ ุงูุณุฌูุงุช](${context.payload.repository.html_url}/actions/runs/${context.runId})`,
              labels: ['gold-analysis', 'error']
            });
          }
    
    - name: ๐งน ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ
      if: always()
      run: |
        # ุงูุงุญุชูุงุธ ุจุงููููุงุช ุงููููุฉ ููุท
        find . -name "*.pyc" -delete 2>/dev/null || true
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        
        echo "๐งน ุชู ุงูุชูุธูู"
