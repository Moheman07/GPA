name: Gold Analysis V3 Auto-Commit

on:
  schedule:
    - cron: '0 */3 * * 1-5'
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas numpy requests scikit-learn xgboost textblob spacy backtrader aiohttp joblib
        python -m spacy download en_core_web_sm || true
        
    - name: Create Simplified Analyzer
      run: |
        cat > fix_analyzer.py << 'EOF'
        import yfinance as yf
        import pandas as pd
        import numpy as np
        from datetime import datetime
        import json
        import warnings
        warnings.filterwarnings('ignore')
        
        print("ðŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø¨Ø³Ø·...")
        
        try:
            # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ù‡Ø¨
            data = yf.download('GC=F', period='1mo', progress=False, auto_adjust=True)
            if data.empty:
                data = yf.download('GLD', period='1mo', progress=False, auto_adjust=True)
            
            if not data.empty:
                latest_price = float(data['Close'].iloc[-1])
                
                # Ø­Ø³Ø§Ø¨ RSI Ø¨Ø³ÙŠØ·
                delta = data['Close'].diff()
                gain = delta.where(delta > 0, 0).rolling(14).mean()
                loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
                rs = gain / loss
                rsi = 100 - (100 / (1 + rs))
                latest_rsi = float(rsi.iloc[-1])
                
                # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
                sma_20 = float(data['Close'].rolling(20).mean().iloc[-1])
                sma_50 = float(data['Close'].rolling(50).mean().iloc[-1]) if len(data) >= 50 else sma_20
                
                # Ø¥Ø´Ø§Ø±Ø© Ù…Ø­Ø³Ù†Ø©
                score = 0
                
                # ØªØ­Ù„ÙŠÙ„ RSI
                if latest_rsi < 30:
                    signal = "Strong Buy"
                    confidence = "High"
                    score = 3
                elif latest_rsi > 70:
                    signal = "Strong Sell"
                    confidence = "High"
                    score = -3
                elif latest_rsi < 45:
                    signal = "Buy"
                    confidence = "Medium"
                    score = 1
                elif latest_rsi > 55:
                    signal = "Sell"
                    confidence = "Medium"
                    score = -1
                else:
                    signal = "Hold"
                    confidence = "Low"
                    score = 0
                
                # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª
                if latest_price > sma_20:
                    score += 0.5
                if latest_price > sma_50:
                    score += 0.5
                
                # ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚
                if score > 2:
                    market_condition = "ØµØ§Ø¹Ø¯ Ù‚ÙˆÙŠ"
                elif score > 0:
                    market_condition = "ØµØ§Ø¹Ø¯"
                elif score < -2:
                    market_condition = "Ù‡Ø§Ø¨Ø· Ù‚ÙˆÙŠ"
                elif score < 0:
                    market_condition = "Ù‡Ø§Ø¨Ø·"
                else:
                    market_condition = "Ø¹Ø±Ø¶ÙŠ"
                
                # Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØµØ­ÙŠØ­Ø©
                summary = {
                    'last_update': datetime.now().isoformat(),
                    'version': '3.0',
                    'signal': signal,
                    'confidence': confidence,
                    'price': round(latest_price, 2),
                    'ml_probability': None,
                    'market_condition': f"{market_condition} - RSI: {latest_rsi:.1f}"
                }
                
                # ØªØ­Ù„ÙŠÙ„ ÙƒØ§Ù…Ù„
                full_analysis = {
                    'timestamp': datetime.now().isoformat(),
                    'status': 'success',
                    'version': '3.0',
                    'gold_analysis': {
                        'signal': signal,
                        'confidence': confidence,
                        'action_recommendation': signal,
                        'total_score': round(score, 2),
                        'current_price': round(latest_price, 2),
                        'technical_summary': {
                            'rsi': round(latest_rsi, 1),
                            'sma_20': round(sma_20, 2),
                            'sma_50': round(sma_50, 2)
                        }
                    },
                    'market_summary': {
                        'last_update': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                        'data_points': len(data),
                        'market_condition': market_condition
                    }
                }
                
                print(f"âœ… Ø§Ù„Ø³Ø¹Ø±: ${latest_price:.2f}")
                print(f"âœ… RSI: {latest_rsi:.1f}")
                print(f"âœ… Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {signal}")
                print(f"âœ… Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚: {market_condition}")
                
            else:
                summary = {
                    'last_update': datetime.now().isoformat(),
                    'version': '3.0',
                    'signal': None,
                    'confidence': None,
                    'price': None,
                    'ml_probability': None,
                    'market_condition': 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'
                }
                full_analysis = {'status': 'error', 'message': 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'}
                print("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            
            # Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
            with open('gold_analysis_summary.json', 'w', encoding='utf-8') as f:
                json.dump(summary, f, ensure_ascii=False, indent=2)
            
            with open('gold_analysis_v3.json', 'w', encoding='utf-8') as f:
                json.dump(full_analysis, f, ensure_ascii=False, indent=2)
                
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£: {e}")
            summary = {
                'last_update': datetime.now().isoformat(),
                'version': '3.0',
                'signal': None,
                'confidence': None,
                'price': None,
                'ml_probability': None,
                'market_condition': f'Ø®Ø·Ø£: {str(e)}'
            }
            with open('gold_analysis_summary.json', 'w', encoding='utf-8') as f:
                json.dump(summary, f, ensure_ascii=False, indent=2)
        EOF
        
        python fix_analyzer.py
        
    - name: Show Results
      run: |
        echo "ðŸ“„ Ù…Ø­ØªÙˆÙ‰ gold_analysis_summary.json:"
        cat gold_analysis_summary.json
        
    - name: Configure Git
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "Gold Analysis Bot V3"
        
    - name: Commit and Push
      run: |
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        git add gold_analysis_v3.json gold_analysis_summary.json || true
        
        # Ø¥Ù†Ø´Ø§Ø¡ commit Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ”„ Update gold analysis V3 - $(date +'%Y-%m-%d %H:%M UTC')"
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ø¹ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© merge
          git pull origin main --no-rebase --strategy=ours || true
          git push origin main
        else
          echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
        fi
