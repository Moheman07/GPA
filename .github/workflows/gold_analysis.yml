name: Gold Analysis V3 Auto-Commit

on:
  schedule:
    - cron: '0 */3 * * 1-5'
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas numpy requests scikit-learn xgboost textblob spacy backtrader aiohttp joblib
        python -m spacy download en_core_web_sm || true
        
    - name: Auto Fix Script Issues
      run: |
        cat > auto_fix.py << 'EOF'
        import re
        
        print("ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹...")
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù
        with open('main_analyzer_v3.py', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø©
        content = re.sub(r'\ndef _get_future_pricesKATEX_INLINE_OPENself, analysis_dateKATEX_INLINE_CLOSE:', r'    def _get_future_prices(self, analysis_date):', content)
        content = re.sub(r'\ndef fetch_multi_timeframe_dataKATEX_INLINE_OPENselfKATEX_INLINE_CLOSE:', r'    def fetch_multi_timeframe_data(self):', content)
        content = re.sub(r'\ndef generate_professional_signals_v3KATEX_INLINE_OPENself,', r'    def generate_professional_signals_v3(self,', content)
        
        # Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ‚Ø§Ø·Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©
        content = re.sub(r'\n\s+# Ø§Ù„ØªÙ‚Ø§Ø·Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©', r'\n            # Ø§Ù„ØªÙ‚Ø§Ø·Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©', content)
        
        # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ØµØ­Ø­
        with open('main_analyzer_v3.py', 'w', encoding='utf-8') as f:
            f.write(content)
        
        print("âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø³ÙƒØ±Ø¨Øª!")
        EOF
        
        python auto_fix.py
        
    - name: Run Analysis V3
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        echo "ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„..."
        python main_analyzer_v3.py || {
          echo "âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¨Ø³ÙŠØ·..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¨Ø³ÙŠØ· ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
          cat > simple_analysis.py << 'EOF'
          import yfinance as yf
          import json
          from datetime import datetime
          
          try:
              data = yf.download('GC=F', period='1mo', progress=False, auto_adjust=True)
              if not data.empty:
                  latest_price = float(data['Close'].iloc[-1])
                  
                  # Ø­Ø³Ø§Ø¨ RSI Ø¨Ø³ÙŠØ·
                  delta = data['Close'].diff()
                  gain = delta.where(delta > 0, 0).rolling(14).mean()
                  loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
                  rs = gain / loss
                  rsi = 100 - (100 / (1 + rs))
                  latest_rsi = float(rsi.iloc[-1])
                  
                  # Ø¥Ø´Ø§Ø±Ø© Ø¨Ø³ÙŠØ·Ø©
                  if latest_rsi < 30:
                      signal = "Strong Buy"
                      confidence = "High"
                  elif latest_rsi < 45:
                      signal = "Buy"
                      confidence = "Medium"
                  elif latest_rsi > 70:
                      signal = "Strong Sell"
                      confidence = "High"
                  elif latest_rsi > 55:
                      signal = "Sell"
                      confidence = "Medium"
                  else:
                      signal = "Hold"
                      confidence = "Low"
                  
                  # Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                  summary = {
                      'last_update': datetime.now().isoformat(),
                      'version': '3.0',
                      'signal': signal,
                      'confidence': confidence,
                      'price': round(latest_price, 2),
                      'ml_probability': None,
                      'market_condition': f"{signal} - RSI: {latest_rsi:.1f}"
                  }
                  
                  with open('gold_analysis_summary.json', 'w') as f:
                      json.dump(summary, f, indent=2)
                  
                  analysis = {
                      'timestamp': datetime.now().isoformat(),
                      'status': 'success',
                      'version': '3.0',
                      'gold_analysis': {
                          'signal': signal,
                          'confidence': confidence,
                          'current_price': round(latest_price, 2),
                          'technical_summary': {'rsi': round(latest_rsi, 1)}
                      }
                  }
                  
                  with open('gold_analysis_v3.json', 'w') as f:
                      json.dump(analysis, f, indent=2)
                  
                  print(f"âœ… Ø§Ù„Ø³Ø¹Ø±: ${latest_price:.2f}")
                  print(f"âœ… RSI: {latest_rsi:.1f}")
                  print(f"âœ… Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {signal}")
              
          except Exception as e:
              print(f"âŒ Ø®Ø·Ø£: {e}")
              # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§ÙØªØ±Ø§Ø¶ÙŠ
              default_summary = {
                  'last_update': datetime.now().isoformat(),
                  'version': '3.0',
                  'signal': None,
                  'confidence': None,
                  'price': None,
                  'ml_probability': None,
                  'market_condition': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„'
              }
              with open('gold_analysis_summary.json', 'w') as f:
                  json.dump(default_summary, f, indent=2)
          EOF
          
          python simple_analysis.py
        }
        
    - name: Verify Results
      run: |
        echo "ğŸ“„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬..."
        if [ -f "gold_analysis_summary.json" ]; then
          echo "Ù…Ø­ØªÙˆÙ‰ gold_analysis_summary.json:"
          cat gold_analysis_summary.json
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©
          python -c "
import json
with open('gold_analysis_summary.json', 'r') as f:
    data = json.load(f)
    if data.get('price'):
        print(f'âœ… Ø§Ù„Ø³Ø¹Ø±: \${data[\"price\"]}')
        print(f'âœ… Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {data.get(\"signal\", \"N/A\")}')
        print(f'âœ… Ø§Ù„Ø«Ù‚Ø©: {data.get(\"confidence\", \"N/A\")}')
    else:
        print('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©')
          "
        else
          echo "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬"
        fi
        
    - name: Configure Git
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "Gold Analysis Bot V3"
        
    - name: Commit and Push Results
      run: |
        # Ø³Ø­Ø¨ Ø¢Ø®Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        git pull origin main --no-rebase || true
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
        git add gold_analysis_v3.json gold_analysis_summary.json analysis_history.db *.pkl || true
        
        # Ø¥Ù†Ø´Ø§Ø¡ commit
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ”„ Update gold analysis V3 - $(date +'%Y-%m-%d %H:%M UTC')"
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯ÙØ¹
          git push origin main || {
            echo "âš ï¸ ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø£ÙˆÙ„ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰..."
            git pull origin main --no-rebase
            git push origin main
          }
        else
          echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
        fi
