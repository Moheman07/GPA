name: Gold Analysis V3 Auto-Commit

on:
  schedule:
    - cron: '0 */3 * * 1-5'
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # مهم لحل مشاكل Git
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas numpy requests scikit-learn xgboost textblob spacy backtrader aiohttp joblib
        python -m spacy download en_core_web_sm || true
        
    - name: Create Simplified Analyzer
      run: |
        cat > fix_analyzer.py << 'EOF'
        import yfinance as yf
        import pandas as pd
        import numpy as np
        from datetime import datetime
        import json
        import warnings
        warnings.filterwarnings('ignore')
        
        print("🚀 تشغيل المحلل المبسط...")
        
        try:
            # جلب بيانات الذهب
            data = yf.download('GC=F', period='1mo', progress=False, auto_adjust=True)
            if data.empty:
                data = yf.download('GLD', period='1mo', progress=False, auto_adjust=True)
            
            if not data.empty:
                latest_price = float(data['Close'].iloc[-1])
                
                # حساب RSI بسيط
                delta = data['Close'].diff()
                gain = delta.where(delta > 0, 0).rolling(14).mean()
                loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
                rs = gain / loss
                rsi = 100 - (100 / (1 + rs))
                latest_rsi = float(rsi.iloc[-1])
                
                # إشارة بسيطة
                if latest_rsi < 30:
                    signal = "Buy"
                    confidence = "High"
                elif latest_rsi > 70:
                    signal = "Sell"
                    confidence = "High"
                elif latest_rsi < 45:
                    signal = "Buy"
                    confidence = "Medium"
                elif latest_rsi > 55:
                    signal = "Sell"
                    confidence = "Medium"
                else:
                    signal = "Hold"
                    confidence = "Low"
                
                # حفظ النتائج
                summary = {
                    'last_update': datetime.now().isoformat(),
                    'version': '3.0',
                    'signal': signal,
                    'confidence': confidence,
                    'price': round(latest_price, 2),
                    'ml_probability': None,
                    'market_condition': f"{signal} - RSI: {latest_rsi:.1f}"
                }
                
                print(f"✅ السعر: ${latest_price:.2f}")
                print(f"✅ RSI: {latest_rsi:.1f}")
                print(f"✅ الإشارة: {signal}")
                
            else:
                summary = {
                    'last_update': datetime.now().isoformat(),
                    'version': '3.0',
                    'signal': None,
                    'confidence': None,
                    'price': None,
                    'ml_probability': None,
                    'market_condition': 'فشل جلب البيانات'
                }
                print("❌ فشل جلب البيانات")
            
            # حفظ الملخص
            with open('gold_analysis_summary.json', 'w') as f:
                json.dump(summary, f, indent=2)
            
            # حفظ نسخة كاملة
            with open('gold_analysis_v3.json', 'w') as f:
                json.dump({'status': 'success', 'summary': summary}, f, indent=2)
                
        except Exception as e:
            print(f"❌ خطأ: {e}")
            summary = {
                'last_update': datetime.now().isoformat(),
                'version': '3.0',
                'signal': None,
                'confidence': None,
                'price': None,
                'ml_probability': None,
                'market_condition': f'خطأ: {str(e)}'
            }
            with open('gold_analysis_summary.json', 'w') as f:
                json.dump(summary, f, indent=2)
        EOF
        
        python fix_analyzer.py
        
    - name: Run Original Analysis (Optional)
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      continue-on-error: true
      run: |
        if [ -f "main_analyzer_v3.py" ]; then
          python main_analyzer_v3.py || echo "فشل التحليل الأصلي - استخدام المبسط"
        fi
        
    - name: Show Results
      run: |
        echo "📄 محتوى gold_analysis_summary.json:"
        cat gold_analysis_summary.json
        
    - name: Commit and Push Results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Gold Analysis Bot V3"
        
        # سحب آخر التغييرات أولاً
        git pull origin main --rebase || true
        
        # إضافة الملفات
        git add gold_analysis_v3.json || true
        git add gold_analysis_summary.json || true
        git add analysis_history.db || true
        git add *.pkl || true
        
        # التحقق من وجود تغييرات
        if git diff --staged --quiet; then
          echo "لا توجد تغييرات للحفظ"
        else
          git commit -m "🔄 Update gold analysis V3 - $(date +'%Y-%m-%d %H:%M UTC')"
          
          # محاولة الدفع مع إعادة المحاولة في حالة الفشل
          for i in 1 2 3; do
            git push && break || {
              echo "محاولة $i فشلت، إعادة المحاولة..."
              git pull --rebase origin main
              sleep 5
            }
          done
        fi
