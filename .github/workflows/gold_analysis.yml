name: Gold Analysis

on:
  schedule:
    - cron: '0 */3 * * 1-5'  # ÙƒÙ„ 3 Ø³Ø§Ø¹Ø§Øª ÙÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Ù…Ù‡Ù… Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Analysis
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
      run: python main_analyzer.py
        
    - name: List generated files
      run: |
        echo "Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙ†Ø´Ø£Ø©:"
        ls -la *.json || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª JSON"
        
    - name: Upload to Artifacts (Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)
      uses: actions/upload-artifact@v4
      with:
        name: gold-analysis-${{ github.run_number }}
        path: "*.json"
        retention-days: 30
        
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Gold Analysis Bot"
        
    - name: Add and commit files
      run: |
        # Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª JSON
        git add *.json
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --staged --quiet; then
          echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø±ÙØ¹"
        else
          # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù€ commit Ù…Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          if [ -f "gold_analysis_latest.json" ]; then
            SIGNAL=$(python -c "import json; data=json.load(open('gold_analysis_latest.json')); print(data.get('gold_analysis', {}).get('signal', 'N/A'))")
            PRICE=$(python -c "import json; data=json.load(open('gold_analysis_latest.json')); print(data.get('gold_analysis', {}).get('price_usd', 'N/A'))")
            git commit -m "ğŸ”„ Gold Analysis Update: $SIGNAL signal at \$$PRICE ($(date +'%Y-%m-%d %H:%M UTC'))"
          else
            git commit -m "ğŸ”„ Gold Analysis Update ($(date +'%Y-%m-%d %H:%M UTC'))"
          fi
          
          # Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­"
        fi

    - name: Create/Update README with results
      if: success()
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« README Ù…Ø¹ Ø¢Ø®Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        python create_readme.py
        
        # Ø±ÙØ¹ README Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡
        if git diff --quiet README.md; then
          echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ README"
        else
          git add README.md
          git commit -m "ğŸ“Š Update README with latest analysis"
          git push origin HEAD:${{ github.ref_name }}
        fi
