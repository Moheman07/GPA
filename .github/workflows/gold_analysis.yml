name: ğŸ† Enhanced Gold Analysis V3.0

on:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 4 Ø³Ø§Ø¹Ø§Øª ÙÙŠ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø·Ø©
    - cron: '0 6,10,14,18,22 * * 1-5'  # Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„
    - cron: '0 12 * * 0,6'              # Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„'
        required: false
        default: 'full'
        type: choice
        options:
        - full
        - quick
        - ml_only

env:
  # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
  PYTHONPATH: ${{ github.workspace }}
  TZ: 'UTC'

jobs:
  enhanced-gold-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: âš¡ ØªØ­Ø¯ÙŠØ« pip ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      run: |
        echo "ğŸš€ ØªØ­Ø¯ÙŠØ« pip..."
        python -m pip install --upgrade pip setuptools wheel
        
        echo "ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©..."
        pip install -r requirements.txt --timeout 300 --retries 3
        
        echo "ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø«Ø¨ØªØ©:"
        pip list | grep -E "(yfinance|pandas|numpy|scikit|xgboost)"
    
    - name: ğŸ”§ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ¦Ø©
      run: |
        echo "ğŸŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©: $(date)"
        echo "ğŸ Ø¥ØµØ¯Ø§Ø± Python: $(python --version)"
        echo "ğŸ’¾ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù‚Ø±Øµ: $(df -h . | tail -1)"
        echo "ğŸ§  Ø§Ù„Ø°Ø§ÙƒØ±Ø©: $(free -h)"
    
    - name: ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…Ø­Ø³Ù†
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        ANALYSIS_TYPE: ${{ github.event.inputs.analysis_type || 'full' }}
      run: |
        echo "ğŸ¯ Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„: $ANALYSIS_TYPE"
        
        echo "ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:"
        ls -la *.py 2>/dev/null || echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Python"
        
        # ØªØ¬Ø±Ø¨Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
        if [ -f "simple_gold_analyzer.py" ]; then
          echo "âœ… ØªØ´ØºÙŠÙ„ simple_gold_analyzer.py"
          python simple_gold_analyzer.py
        elif [ -f "enhanced_gold_analyzer_github.py" ]; then
          echo "âœ… ØªØ´ØºÙŠÙ„ enhanced_gold_analyzer_github.py"
          python enhanced_gold_analyzer_github.py
        elif [ -f "gold_analyzer.py" ]; then
          echo "âœ… ØªØ´ØºÙŠÙ„ gold_analyzer.py"
          python gold_analyzer.py
        else
          echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø³ÙƒØ±Ø¨Øª Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ†ÙÙŠØ°"
          echo "ğŸ“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯:"
          ls -la
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø¨Ø³ÙŠØ· ÙƒØ¨Ø¯ÙŠÙ„ Ø·ÙˆØ§Ø±Ø¦
          echo "ğŸ”„ Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±Ø¨Øª Ø¨Ø³ÙŠØ· Ø¨Ø¯ÙŠÙ„..."
          cat > temp_analyzer.py << 'EOF'
#!/usr/bin/env python3
import yfinance as yf
import pandas as pd
import json
from datetime import datetime

def simple_gold_analysis():
    try:
        print("ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø¨Ø³ÙŠØ·...")
        
        # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ù‡Ø¨
        gold_data = yf.download('GC=F', period='1mo', progress=False)
        
        if gold_data.empty:
            raise ValueError("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ù‡Ø¨")
        
        current_price = gold_data['Close'].iloc[-1]
        prev_price = gold_data['Close'].iloc[-2]
        change = current_price - prev_price
        change_pct = (change / prev_price) * 100
        
        # Ø­Ø³Ø§Ø¨ RSI Ø¨Ø³ÙŠØ·
        delta = gold_data['Close'].diff()
        gain = delta.where(delta > 0, 0).rolling(14).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
        rs = gain / loss
        rsi = 100 - (100 / (1 + rs))
        current_rsi = rsi.iloc[-1]
        
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
        if current_rsi < 30:
            signal = "Buy - Oversold"
        elif current_rsi > 70:
            signal = "Sell - Overbought"  
        elif change_pct > 1:
            signal = "Strong Bullish"
        elif change_pct < -1:
            signal = "Strong Bearish"
        else:
            signal = "Neutral"
        
        result = {
            'timestamp': datetime.now().isoformat(),
            'current_price': round(float(current_price), 2),
            'change': round(float(change), 2),
            'change_pct': round(float(change_pct), 2),
            'rsi': round(float(current_rsi), 1),
            'signal': signal,
            'status': 'success'
        }
        
        # Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        with open('gold_analysis_emergency.json', 'w') as f:
            json.dump(result, f, indent=2)
        
        print(f"âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­")
        print(f"ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨: ${current_price:.2f}")
        print(f"ğŸ“ˆ Ø§Ù„ØªØºÙŠÙŠØ±: {change_pct:.2f}%")
        print(f"ğŸ“Š RSI: {current_rsi:.1f}")
        print(f"ğŸ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {signal}")
        
        return result
        
    except Exception as e:
        error_result = {
            'timestamp': datetime.now().isoformat(),
            'error': str(e),
            'status': 'error'
        }
        
        with open('gold_analysis_error.json', 'w') as f:
            json.dump(error_result, f, indent=2)
        
        print(f"âŒ Ø®Ø·Ø£: {e}")
        return error_result

if __name__ == "__main__":
    simple_gold_analysis()
EOF
          
          python temp_analyzer.py
        fi
        
        echo "âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„"
    
    - name: ğŸ“Š Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      if: always()
      run: |
        echo "ğŸ“‹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ§Ø­Ø©:"
        ls -la *.json *.txt 2>/dev/null || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù†ØªØ§Ø¦Ø¬"
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹
        if [ -f "gold_summary_"*.json ]; then
          echo "ğŸ“ˆ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø±ÙŠØ¹:"
          cat gold_summary_*.json | head -20
        fi
    
    - name: ğŸ’¾ Ø±ÙØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙƒÙ€ Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gold-analysis-results-${{ github.run_number }}
        path: |
          *.json
          *.txt
          *.pkl
          *.db
        retention-days: 30
        if-no-files-found: warn
    
    - name: ğŸ“¢ Ø¥Ù†Ø´Ø§Ø¡ Issue Ù…Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„
      if: success()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            const files = fs.readdirSync('.');
            const summaryFile = files.find(f => f.startsWith('gold_summary_') && f.endsWith('.json'));
            const analysisFile = files.find(f => f.startsWith('gold_analysis_v3_') && f.endsWith('.json'));
            
            let issueBody = `## ğŸ† ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„Ø°Ù‡Ø¨ V3.0\n\n`;
            issueBody += `**â° ÙˆÙ‚Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„:** ${new Date().toISOString()}\n`;
            issueBody += `**ğŸ”„ Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„:** #${context.runNumber}\n`;
            issueBody += `**âš™ï¸ Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„:** ${process.env.ANALYSIS_TYPE || 'full'}\n\n`;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø±ÙŠØ¹
            if (summaryFile) {
              try {
                const summary = JSON.parse(fs.readFileSync(summaryFile, 'utf8'));
                issueBody += `### ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø±ÙŠØ¹\n\n`;
                issueBody += `- **Ø§Ù„Ø¥Ø´Ø§Ø±Ø©:** ${summary.signal || 'N/A'}\n`;
                issueBody += `- **Ø§Ù„Ø«Ù‚Ø©:** ${summary.confidence || 'N/A'}\n`;
                issueBody += `- **Ø§Ù„Ø³Ø¹Ø±:** $${summary.price || 'N/A'}\n`;
                issueBody += `- **Ø§Ù„ØªÙˆØµÙŠØ©:** ${summary.recommendation || 'N/A'}\n\n`;
              } catch (e) {
                console.log('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ø®Øµ:', e.message);
              }
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ù„Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
            issueBody += `### ğŸ“ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙƒØ§Ù…Ù„Ø©\n\n`;
            issueBody += `ğŸ”— [ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n`;
            
            // Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ ØªÙ‚Ù†ÙŠØ©
            issueBody += `### ğŸ”§ ØªÙØ§ØµÙŠÙ„ ØªÙ‚Ù†ÙŠØ©\n\n`;
            issueBody += `- **Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª:** yfinance, scikit-learn, xgboost\n`;
            issueBody += `- **Ø§Ù„Ù…ÙŠØ²Ø§Øª:** ØªØ¹Ù„Ù… Ø¢Ù„ÙŠ, ØªØ­Ù„ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø·Ø±, ØªØ­Ù„ÙŠÙ„ Ø£Ø®Ø¨Ø§Ø±\n`;
            issueBody += `- **Ø§Ù„Ø¨ÙŠØ¦Ø©:** GitHub Actions Ubuntu Latest\n\n`;
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ³Ù…ÙŠØ§Øª
            const labels = ['gold-analysis', 'automated'];
            if (summaryFile) {
              const summary = JSON.parse(fs.readFileSync(summaryFile, 'utf8'));
              if (summary.signal && summary.signal.includes('Buy')) {
                labels.push('bullish');
              } else if (summary.signal && summary.signal.includes('Sell')) {
                labels.push('bearish');
              }
            }
            
            issueBody += `---\n*ğŸ¤– ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Enhanced Gold Analyzer V3.0*`;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ V3.0 - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: labels
            });
            
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Issue Ø¨Ù†Ø¬Ø§Ø­');
            
          } catch (error) {
            console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Issue:', error.message);
            
            // Ø¥Ù†Ø´Ø§Ø¡ issue Ù…Ø¨Ø³Ø· ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ - ${new Date().toISOString().split('T')[0]}`,
              body: `## ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ\n\nâŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬\n\n**Ø§Ù„Ø®Ø·Ø£:** ${error.message}\n\nğŸ”— [Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª](${context.payload.repository.html_url}/actions/runs/${context.runId})`,
              labels: ['gold-analysis', 'error']
            });
          }
    
    - name: ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      if: always()
      run: |
        # Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·
        find . -name "*.pyc" -delete 2>/dev/null || true
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        
        echo "ğŸ§¹ ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ"
