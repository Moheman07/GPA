name: Gold Analysis V3 Auto-Commit

on:
  schedule:
    - cron: '0 */3 * * 1-5'
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Ù…Ù‡Ù… Ù„Ø­Ù„ Ù…Ø´Ø§ÙƒÙ„ Git
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas numpy requests scikit-learn xgboost textblob spacy backtrader aiohttp joblib
        python -m spacy download en_core_web_sm || true
        
    - name: Create Simplified Analyzer
      run: |
        cat > fix_analyzer.py << 'EOF'
        import yfinance as yf
        import pandas as pd
        import numpy as np
        from datetime import datetime
        import json
        import warnings
        warnings.filterwarnings('ignore')
        
        print("ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø¨Ø³Ø·...")
        
        try:
            # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ù‡Ø¨
            data = yf.download('GC=F', period='1mo', progress=False, auto_adjust=True)
            if data.empty:
                data = yf.download('GLD', period='1mo', progress=False, auto_adjust=True)
            
            if not data.empty:
                latest_price = float(data['Close'].iloc[-1])
                
                # Ø­Ø³Ø§Ø¨ RSI Ø¨Ø³ÙŠØ·
                delta = data['Close'].diff()
                gain = delta.where(delta > 0, 0).rolling(14).mean()
                loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
                rs = gain / loss
                rsi = 100 - (100 / (1 + rs))
                latest_rsi = float(rsi.iloc[-1])
                
                # Ø¥Ø´Ø§Ø±Ø© Ø¨Ø³ÙŠØ·Ø©
                if latest_rsi < 30:
                    signal = "Buy"
                    confidence = "High"
                elif latest_rsi > 70:
                    signal = "Sell"
                    confidence = "High"
                elif latest_rsi < 45:
                    signal = "Buy"
                    confidence = "Medium"
                elif latest_rsi > 55:
                    signal = "Sell"
                    confidence = "Medium"
                else:
                    signal = "Hold"
                    confidence = "Low"
                
                # Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                summary = {
                    'last_update': datetime.now().isoformat(),
                    'version': '3.0',
                    'signal': signal,
                    'confidence': confidence,
                    'price': round(latest_price, 2),
                    'ml_probability': None,
                    'market_condition': f"{signal} - RSI: {latest_rsi:.1f}"
                }
                
                print(f"âœ… Ø§Ù„Ø³Ø¹Ø±: ${latest_price:.2f}")
                print(f"âœ… RSI: {latest_rsi:.1f}")
                print(f"âœ… Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {signal}")
                
            else:
                summary = {
                    'last_update': datetime.now().isoformat(),
                    'version': '3.0',
                    'signal': None,
                    'confidence': None,
                    'price': None,
                    'ml_probability': None,
                    'market_condition': 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'
                }
                print("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            
            # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø®Øµ
            with open('gold_analysis_summary.json', 'w') as f:
                json.dump(summary, f, indent=2)
            
            # Ø­ÙØ¸ Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø©
            with open('gold_analysis_v3.json', 'w') as f:
                json.dump({'status': 'success', 'summary': summary}, f, indent=2)
                
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£: {e}")
            summary = {
                'last_update': datetime.now().isoformat(),
                'version': '3.0',
                'signal': None,
                'confidence': None,
                'price': None,
                'ml_probability': None,
                'market_condition': f'Ø®Ø·Ø£: {str(e)}'
            }
            with open('gold_analysis_summary.json', 'w') as f:
                json.dump(summary, f, indent=2)
        EOF
        
        python fix_analyzer.py
        
    - name: Run Original Analysis (Optional)
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      continue-on-error: true
      run: |
        if [ -f "main_analyzer_v3.py" ]; then
          python main_analyzer_v3.py || echo "ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¨Ø³Ø·"
        fi
        
    - name: Show Results
      run: |
        echo "ğŸ“„ Ù…Ø­ØªÙˆÙ‰ gold_analysis_summary.json:"
        cat gold_analysis_summary.json
        
    - name: Commit and Push Results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Gold Analysis Bot V3"
        
        # Ø³Ø­Ø¨ Ø¢Ø®Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
        git pull origin main --rebase || true
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
        git add gold_analysis_v3.json || true
        git add gold_analysis_summary.json || true
        git add analysis_history.db || true
        git add *.pkl || true
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --staged --quiet; then
          echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
        else
          git commit -m "ğŸ”„ Update gold analysis V3 - $(date +'%Y-%m-%d %H:%M UTC')"
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
          for i in 1 2 3; do
            git push && break || {
              echo "Ù…Ø­Ø§ÙˆÙ„Ø© $i ÙØ´Ù„ØªØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©..."
              git pull --rebase origin main
              sleep 5
            }
          done
        fi
