name: Gold Analysis Automation

on:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠ ÙÙŠ Ø£ÙØ¶Ù„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨
    - cron: '30 13 * * 1-5'  # 1:30 PM UTC (Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ)
    - cron: '0 21 * * 1-5'   # 9:00 PM UTC (Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ)
    - cron: '0 7 * * 1-5'    # 7:00 AM UTC (Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ)
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:
  
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ push (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
  push:
    branches: [ main ]
    paths: 
      - 'main_analyzer.py'

env:
  NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}

jobs:
  gold-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ” Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1

    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: âš¡ Install Dependencies (Optimized)
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir yfinance pandas numpy requests transformers torch pandas-ta pytz
        python -c "from transformers import pipeline; pipeline('sentiment-analysis', model='ProsusAI/finbert')" # ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø¨Ù‚

    - name: ğŸƒâ€â™‚ï¸ Run Gold Analysis
      run: |
        echo "ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨..."
        python main_analyzer.py
        echo "âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„"

    - name: ğŸ“Š Verify Output Files
      run: |
        echo "ğŸ“ ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙ†Ø´Ø£Ø©:"
        ls -la *.json *.db *.log 2>/dev/null || echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª"
        
        if [ -f "gold_analysis_enhanced.json" ]; then
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù JSON Ø¨Ø­Ø¬Ù…: $(stat -c%s gold_analysis_enhanced.json) bytes"
          echo "ğŸ“‹ Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 500 Ø­Ø±Ù Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬:"
          head -c 500 gold_analysis_enhanced.json
        else
          echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù JSON"
          exit 1
        fi

    - name: ğŸ“ˆ Create Analysis Summary
      run: |
        python -c "
        import json
        from datetime import datetime
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        with open('gold_analysis_enhanced.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø®Øµ markdown
        summary = f'''# ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ - {datetime.now().strftime('%Y-%m-%d %H:%M')} UTC
        
## Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
- **Ø§Ù„Ø¥Ø´Ø§Ø±Ø©**: {data['signal']} ({data['signal_strength']})
- **Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©**: {data['total_score']}
- **Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨**: ${data['market_data']['gold_price']}
- **ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©**: ${data['stop_loss_price']}
- **Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚**: {data['market_volatility']}

## Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„
- **Ø§Ù„Ø§ØªØ¬Ø§Ù‡**: {data['components']['trend_score']}
- **Ø§Ù„Ø²Ø®Ù…**: {data['components']['momentum_score']}
- **Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·**: {data['components']['correlation_score']}
- **Ø§Ù„Ø£Ø®Ø¨Ø§Ø±**: {data['components']['news_score']}
- **Ø§Ù„ØªÙ‚Ù„Ø¨Ø§Øª**: {data['components']['volatility_score']}

## Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙ‚
- **Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (DXY)**: {data['market_data']['dxy']}
- **Ù…Ø¤Ø´Ø± Ø§Ù„Ø®ÙˆÙ (VIX)**: {data['market_data']['vix']}
- **ATR**: {data['market_data']['atr']}

## ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
- **Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„**: {data['news_analysis']['status']}
- **Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø´Ø§Ø¹Ø±**: {data['news_analysis']['news_sentiment_score']}
- **Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª**: {data['news_analysis'].get('analysis_details', {}).get('total_articles_analyzed', 0)}

---
*Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {data['timestamp_utc']}*
        '''
        
        with open('README.md', 'w', encoding='utf-8') as f:
            f.write(summary)
        
        print('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù README.md')
        "

    - name: ğŸ’¾ Commit and Push Results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Gold Analysis Bot"
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        git add -A
        
        # ÙØ­Øµ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --staged --quiet; then
          echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
        else
          echo "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©..."
          git commit -m "ğŸ¤– ØªØ­Ø¯ÙŠØ« ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨ - $(date '+%Y-%m-%d %H:%M UTC')"
          git push
          echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ GitHub"
        fi

    - name: ğŸš¨ Notification on Failure
      if: failure()
      run: |
        echo "âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°Ù‡Ø¨"
        echo "Ø³Ø¨Ø¨ Ø§Ù„ÙØ´Ù„ Ù‚Ø¯ ÙŠÙƒÙˆÙ†:"
        echo "- Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
        echo "- Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ NewsAPI" 
        echo "- Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±"

    - name: ğŸ“¤ Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: gold-analysis-files
        path: |
          *.json
          *.db
          *.log
        retention-days: 30