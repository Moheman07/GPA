name: Gold Analysis V3 Auto-Commit

on:
  schedule:
    - cron: '0 */3 * * 1-5'
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m spacy download en_core_web_sm
        
    - name: Test Basic Functionality
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        cat > test_analyzer.py << 'EOF'
        import yfinance as yf
        import os
        from datetime import datetime
        
        print("ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...")
        print("="*50)
        
        # Ø§Ø®ØªØ¨Ø§Ø± yfinance
        print("\n1. Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ù‡Ø¨:")
        try:
            gold_data = yf.download('GC=F', period='5d', progress=False)
            if not gold_data.empty:
                print(f"âœ… Ù†Ø¬Ø­ - Ø¢Ø®Ø± Ø³Ø¹Ø±: ${gold_data['Close'].iloc[-1]:.2f}")
            else:
                print("âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©")
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£: {e}")
        
        # Ø§Ø®ØªØ¨Ø§Ø± API keys
        print("\n2. Ù…ÙØ§ØªÙŠØ­ API:")
        print(f"NEWS_API_KEY: {'âœ… Ù…ÙˆØ¬ÙˆØ¯' if os.getenv('NEWS_API_KEY') else 'âŒ Ù…ÙÙ‚ÙˆØ¯'}")
        print(f"FRED_API_KEY: {'âœ… Ù…ÙˆØ¬ÙˆØ¯' if os.getenv('FRED_API_KEY') else 'âš ï¸ Ù…ÙÙ‚ÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'}")
        EOF
        
        python test_analyzer.py
        
    - name: Run Analysis V3
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        python main_analyzer_v3.py || echo "ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"
        
        # Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø©
        echo -e "\nğŸ“„ Ù…Ø­ØªÙˆÙ‰ gold_analysis_summary.json:"
        cat gold_analysis_summary.json 2>/dev/null || echo "Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
        
    - name: Commit and Push Results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Gold Analysis Bot V3"
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
        git add gold_analysis_v3.json || true
        git add gold_analysis_summary.json || true
        git add analysis_history.db || true
        git add *.pkl || true
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --staged --quiet; then
          echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
        else
          git commit -m "ğŸ”„ Update gold analysis V3 - $(date +'%Y-%m-%d %H:%M UTC')"
          git push
        fi
