name: Gold Trading Analysis

on:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ø³Ø§Ø¹ØªÙŠÙ† ÙÙŠ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (9 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¥Ù„Ù‰ 5 Ù…Ø³Ø§Ø¡Ù‹ EST)
    - cron: '0 14,16,18,20,22 * * 1-5'  # UTC time (EST + 5)
  workflow_dispatch: # Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
  push:
    branches: [ main, master ]

env:
  TZ: America/New_York

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y tzdata
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify installation
      run: |
        python -c "import yfinance; print('yfinance OK')"
        python -c "import pandas; print('pandas OK')"
        python -c "import pandas_ta; print('pandas_ta OK')"
        
    - name: Run Gold Analysis
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "Starting Gold Analysis..."
        python main_analyzer.py
        echo "Analysis completed successfully!"
        
    - name: List generated files
      run: |
        echo "Generated files:"
        ls -la results/ || echo "No results directory"
        ls -la *.json || echo "No JSON files"
        ls -la *.txt || echo "No TXT files"
        ls -la *.html || echo "No HTML files"
        
    - name: Upload Analysis Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gold-analysis-results-${{ github.run_number }}
        path: |
          results/
          *.json
          *.txt
          *.html
          logs/
        retention-days: 30
        if-no-files-found: warn
        
    - name: Create Release Summary
      run: |
        echo "# Gold Analysis Results - $(date)" > release_summary.md
        echo "" >> release_summary.md
        echo "## Analysis completed at: $(date)" >> release_summary.md
        echo "" >> release_summary.md
        if [ -f "results/gold_analysis_summary.txt" ]; then
          echo "## Summary:" >> release_summary.md
          echo '```' >> release_summary.md
          cat results/gold_analysis_summary.txt >> release_summary.md
          echo '```' >> release_summary.md
        fi
        
    - name: Commit and push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
        git add -A
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– Auto-update: Gold analysis $(date +'%Y-%m-%d %H:%M EST')" || echo "Nothing to commit"
          git push || echo "Nothing to push"
        fi

    - name: Send Telegram notification
      if: success()
      run: |
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          python send_telegram.py
        else
          echo "Telegram credentials not configured"
        fi
