name: ðŸ† Gold Analysis Professional

on:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠ ÙÙŠ Ø£ÙˆÙ‚Ø§Øª Ù…Ø®ØªÙ„ÙØ© (UTC)
    - cron: '30 13 * * 1-5'    # 1:30 PM UTC - Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ
    - cron: '0 21 * * 1-5'     # 9:00 PM UTC - Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³ÙˆÙ‚  
    - cron: '0 7 * * 1-5'      # 7:00 AM UTC - Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ
    
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run analysis'
        required: false
        default: 'true'
        
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ push Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
  push:
    branches: [ main, master ]
    paths: 
      - '**.py'

env:
  # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
  NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
  PYTHONUNBUFFERED: 1
  PYTHONIOENCODING: utf-8

jobs:
  gold-analysis:
    name: ðŸ“Š Gold Market Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­
    
    # Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„ÙƒØªØ§Ø¨Ø©
    permissions:
      contents: write
      actions: write
    
    steps:
    - name: ðŸ” Checkout Repository  
      uses: actions/checkout@v4
      with:
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… GITHUB_TOKEN Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ðŸ Setup Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ðŸš€ Install Dependencies (Optimized)
      run: |
        echo "ðŸ“¦ Installing Python packages..."
        python -m pip install --upgrade pip --quiet
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
        pip install --no-cache-dir --quiet numpy pandas requests
        
        # ØªØ­Ù…ÙŠÙ„ yfinance Ùˆpandas-ta
        pip install --no-cache-dir --quiet yfinance pandas-ta pytz
        
        # ØªØ­Ù…ÙŠÙ„ transformers Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø©  
        pip install --no-cache-dir --quiet torch --index-url https://download.pytorch.org/whl/cpu
        pip install --no-cache-dir --quiet transformers
        
        echo "âœ… Dependencies installed successfully"
        
        # ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª
        python -c "import yfinance, pandas, numpy, requests, transformers; print('âœ… All imports successful')"

    - name: ðŸ§  Pre-download AI Model
      run: |
        echo "ðŸ¤– Pre-downloading FinBERT model..."
        python -c "
        try:
            from transformers import pipeline
            print('Loading FinBERT model...')
            pipeline('sentiment-analysis', model='ProsusAI/finbert')
            print('âœ… Model loaded successfully')
        except Exception as e:
            print(f'âš ï¸ Model loading warning: {e}')
            print('Will continue without sentiment analysis')
        " || echo "âš ï¸ Model pre-loading failed, continuing..."

    - name: ðŸ”§ Setup Analysis Environment
      run: |
        echo "âš™ï¸ Setting up analysis environment..."
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù€ cache ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª
        mkdir -p cache logs
        
        # ÙØ­Øµ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
        if [ -z "$NEWS_API_KEY" ]; then
          echo "âš ï¸ NEWS_API_KEY not found - news analysis will be skipped"
        else
          echo "âœ… NEWS_API_KEY is configured"
        fi
        
        # ÙØ­Øµ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©
        df -h
        
        echo "ðŸŽ¯ Environment ready"

    - name: ðŸ† Run Gold Analysis
      id: analysis
      run: |
        echo "ðŸš€ Starting Gold Analysis..."
        echo "â° Start time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        if timeout 600 python main_analyzer.py; then
          echo "âœ… Analysis completed successfully"
          echo "analysis_status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Analysis failed or timed out"
          echo "analysis_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "â° End time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

    - name: ðŸ“Š Verify Analysis Output
      if: steps.analysis.outputs.analysis_status == 'success'
      run: |
        echo "ðŸ” Checking analysis outputs..."
        
        # ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙ†Ø´Ø£Ø©
        if [ -f "gold_analysis_pro.json" ]; then
          echo "âœ… JSON file created: $(stat -c%s gold_analysis_pro.json) bytes"
          
          # Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          echo "ðŸ“‹ Analysis Summary:"
          python -c "
          import json
          try:
              with open('gold_analysis_pro.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              print(f\"Signal: {data.get('signal', 'N/A')} ({data.get('signal_strength', 'N/A')})\")
              print(f\"Score: {data.get('total_score', 'N/A')}\")
              print(f\"Gold Price: ${data.get('market_data', {}).get('gold_price', 'N/A')}\")
              print(f\"Confidence: {data.get('confidence_level', 'N/A'):.1%}\")
              print(f\"Execution Time: {data.get('execution_time_ms', 'N/A')}ms\")
          except Exception as e:
              print(f'Error reading results: {e}')
          "
        else
          echo "âŒ JSON file not found"
          ls -la *.json *.db *.log 2>/dev/null || echo "No output files found"
          exit 1
        fi
        
        # ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if [ -f "gold_analysis_history.db" ]; then
          echo "âœ… Database file created: $(stat -c%s gold_analysis_history.db) bytes"
        fi
        
        # ÙØ­Øµ Ù…Ù„Ù Ø§Ù„Ø³Ø¬Ù„
        if [ -f "gold_analysis_pro.log" ]; then
          echo "âœ… Log file created: $(stat -c%s gold_analysis_pro.log) bytes"
          echo "ðŸ“‹ Last 5 log entries:"
          tail -n 5 gold_analysis_pro.log
        fi

    - name: ðŸ“ˆ Generate Analysis Report
      if: steps.analysis.outputs.analysis_status == 'success'
      run: |
        echo "ðŸ“Š Generating comprehensive report..."
        
        python -c "
        import json
        from datetime import datetime
        import os
        
        try:
            # Ù‚Ø±Ø§Ø¡Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„
            with open('gold_analysis_pro.json', 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± markdown Ù…ÙØµÙ„
            report = f'''# ðŸ“Š Gold Analysis Report - {datetime.now().strftime('%Y-%m-%d %H:%M UTC')}
        
        ## ðŸŽ¯ Trading Signal
        - **Signal**: {data['signal']} 
        - **Strength**: {data['signal_strength']}
        - **Total Score**: {data['total_score']:.3f}
        - **Confidence**: {data['confidence_level']:.1%}
        
        ## ðŸ’° Market Data
        - **Gold Price**: \${data['market_data']['gold_price']:,.2f}
        - **DXY (Dollar Index)**: {data['market_data']['dxy']:.2f}
        - **VIX (Fear Index)**: {data['market_data']['vix']:.2f}
        - **Gold/Silver Ratio**: {data['market_data']['gold_silver_ratio']:.1f}
        
        ## ðŸ“ˆ Technical Analysis
        | Component | Score | Weight |
        |-----------|-------|---------|'''
            
            for component, score in data['score_components'].items():
                weight = data['component_weights'].get(component, 0)
                report += f\"\\n| {component.replace('_', ' ').title()} | {score:.3f} | {weight:.1%} |\"
            
            report += f'''
        
        ## ðŸ”§ Risk Management
        - **Stop Loss**: \${data['risk_management']['stop_loss_price']:.2f}
        - **Take Profit**: \${data['risk_management']['take_profit_price']:.2f}
        - **Position Size**: {data['risk_management']['position_size_percent']:.1f}%
        - **Risk/Reward**: {data['risk_management']['risk_reward_ratio']:.2f}
        
        ## ðŸ“° News Analysis
        - **Status**: {data['news_analysis']['status']}
        - **Sentiment Score**: {data['news_analysis'].get('news_score', 0):.3f}
        - **Articles Analyzed**: {len(data['news_analysis'].get('headlines', []))}
        - **News Confidence**: {data['news_analysis'].get('confidence', 0):.1%}
        
        ## ðŸ”¬ Backtest Results
        - **Total Return**: {data['backtest_results']['total_return_percent']:.2f}%
        - **Sharpe Ratio**: {data['backtest_results']['sharpe_ratio']:.2f}
        - **Max Drawdown**: {data['backtest_results']['max_drawdown_percent']:.2f}%
        - **Win Rate**: {data['backtest_results']['win_rate_percent']:.1f}%
        - **Total Trades**: {data['backtest_results']['total_trades']}
        
        ## ðŸ“‹ Key Headlines
        '''
            
            for i, headline in enumerate(data['news_analysis'].get('headlines', [])[:5], 1):
                report += f\"\\n{i}. **{headline['title']}** - *{headline['source']}*\"
            
            report += f'''
        
        ## âš¡ Performance Metrics
        - **Execution Time**: {data['execution_time_ms']}ms
        - **Data Points**: {data['performance_info']['data_points_analyzed']}
        - **Indicators**: {data['performance_info']['indicators_calculated']}
        - **Analysis ID**: {data.get('analysis_id', 'N/A')}
        
        ---
        *Report generated automatically by Gold Analysis Pro*  
        *Last updated: {data['timestamp_utc']}*
        '''
            
            # Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            with open('ANALYSIS_REPORT.md', 'w', encoding='utf-8') as f:
                f.write(report)
            
            print('âœ… Analysis report generated successfully')
            
        except Exception as e:
            print(f'âŒ Error generating report: {e}')
            
            # Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø¨Ø³ÙŠØ· ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            with open('ANALYSIS_REPORT.md', 'w', encoding='utf-8') as f:
                f.write(f'''# Gold Analysis Report - {datetime.now().strftime('%Y-%m-%d %H:%M UTC')}
        
        âš ï¸ Error generating detailed report: {e}
        
        Basic analysis completed. Check gold_analysis_pro.json for details.
        ''')
            
            print('âš ï¸ Created basic report due to error')
        "

    - name: ðŸ’¾ Commit and Push Results  
      if: steps.analysis.outputs.analysis_status == 'success'
      run: |
        echo "ðŸ’¾ Committing analysis results..."
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Git
        git config --local user.email "action@github.com"
        git config --local user.name "Gold Analysis Bot ðŸ¤–"
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
        git add -A
        
        # ÙØ­Øµ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --staged --quiet; then
          echo "âš ï¸ No changes to commit"
        else
          # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© commit Ù…ÙØµÙ„Ø©
          COMMIT_MSG="ðŸ¤– Gold Analysis Update - $(date -u '+%Y-%m-%d %H:%M UTC')
          
          $(python -c \"
          try:
              import json
              with open('gold_analysis_pro.json', 'r') as f:
                  data = json.load(f)
              print(f'ðŸ“Š Signal: {data[\"signal\"]} ({data[\"signal_strength\"]})')
              print(f'ðŸ“ˆ Score: {data[\"total_score\"]}')  
              print(f'ðŸ’° Gold: \${data[\"market_data\"][\"gold_price\"]}')
              print(f'â±ï¸ Time: {data[\"execution_time_ms\"]}ms')
          except:
              print('ðŸ“Š Analysis completed successfully')
          \")"
          
          echo "Committing with message:"
          echo "$COMMIT_MSG"
          
          git commit -m "$COMMIT_MSG"
          
          # Push Ù…Ø¹ retry
          for i in {1..3}; do
            if git push; then
              echo "âœ… Successfully pushed to repository"
              break
            else
              echo "âš ï¸ Push attempt $i failed, retrying..."
              sleep 5
            fi
          done
        fi

    - name: ðŸ“¤ Upload Artifacts (Backup)
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: gold-analysis-${{ github.run_number }}
        path: |
          *.json
          *.db  
          *.log
          *.md
        retention-days: 30

    - name: ðŸš¨ Failure Notification
      if: failure()
      run: |
        echo "âŒ Gold Analysis Failed!"
        echo "ðŸ” Troubleshooting information:"
        echo "- Workflow run: ${{ github.run_number }}"
        echo "- Repository: ${{ github.repository }}"
        echo "- Commit: ${{ github.sha }}"
        echo "- Event: ${{ github.event_name }}"
        
        # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        echo "ðŸ’» System info:"
        uname -a
        df -h
        free -h
        
        # Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©
        if [ -f "gold_analysis_pro.log" ]; then
          echo "ðŸ“‹ Last log entries:"
          tail -n 20 gold_analysis_pro.log
        fi
        
        # ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        echo "ðŸ“ Files in directory:"
        ls -la
        
        echo "ðŸ’¡ Common solutions:"
        echo "1. Check if NEWS_API_KEY secret is set"
        echo "2. Verify repository permissions"  
        echo "3. Check network connectivity"
        echo "4. Review dependency compatibility"

    - name: âœ… Success Summary
      if: success()
      run: |
        echo "ðŸŽ‰ Gold Analysis completed successfully!"
        echo "ðŸ“Š Analysis summary:"
        
        if [ -f "gold_analysis_pro.json" ]; then
          python -c "
          import json
          with open('gold_analysis_pro.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          print(f'ðŸŽ¯ Signal: {data[\"signal\"]} ({data[\"signal_strength\"]})')
          print(f'ðŸ“ˆ Total Score: {data[\"total_score\"]}')
          print(f'ðŸ’° Gold Price: \${data[\"market_data\"][\"gold_price\"]}')
          print(f'ðŸ”’ Confidence: {data[\"confidence_level\"]:.1%}')
          print(f'âš¡ Execution: {data[\"execution_time_ms\"]}ms')
          print(f'ðŸ“° News Articles: {len(data[\"news_analysis\"].get(\"headlines\", []))}')
          print(f'ðŸ”¬ Backtest Return: {data[\"backtest_results\"][\"total_return_percent\"]}%')
          "
        fi
        
        echo ""
        echo "ðŸ“ Generated files:"
        ls -la *.json *.db *.md 2>/dev/null || echo "No output files"
        
        echo ""
        echo "ðŸ”— Check the repository for updated analysis files!"