name: Gold Analysis + News
on:
  workflow_dispatch:
  schedule:
    - cron: '30 13 * * 1-5'  # ÙŠÙˆÙ…ÙŠ
jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    env:
      NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - run: pip install yfinance pandas numpy requests

    - name: Create Full Analyzer with News
      run: |
        cat > full_analyzer.py << 'EOF'
        import yfinance as yf
        import pandas as pd
        import numpy as np
        import requests
        import json
        import os
        from datetime import datetime, timedelta
        
        def analyze_news():
            """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø³Ø·"""
            api_key = os.getenv('NEWS_API_KEY')
            
            if not api_key:
                return {
                    "status": "no_api_key",
                    "news_score": 0,
                    "articles_count": 0,
                    "headlines": []
                }
            
            try:
                # ÙƒÙ„Ù…Ø§Øª Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© ÙˆØ³Ù„Ø¨ÙŠØ© Ù„Ù„Ø°Ù‡Ø¨
                positive_words = [
                    'surge', 'rise', 'gain', 'bull', 'up', 'higher', 'rally', 'climb',
                    'inflation', 'safe haven', 'uncertainty', 'crisis', 'fear', 
                    'dovish', 'stimulus', 'weak dollar', 'rate cut'
                ]
                
                negative_words = [
                    'fall', 'drop', 'decline', 'bear', 'down', 'lower', 'crash', 'plunge',
                    'strong dollar', 'rate hike', 'hawkish', 'sell-off', 'profit taking'
                ]
                
                # Ø¬Ù„Ø¨ Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨
                queries = [
                    'gold price',
                    'gold market',
                    'federal reserve gold',
                    'inflation gold'
                ]
                
                all_articles = []
                
                for query in queries:
                    url = f"https://newsapi.org/v2/everything?q={query}&language=en&sortBy=publishedAt&pageSize=15&from={(datetime.now() - timedelta(days=2)).date()}&apiKey={api_key}"
                    
                    try:
                        response = requests.get(url, timeout=10)
                        if response.status_code == 200:
                            data = response.json()
                            all_articles.extend(data.get('articles', []))
                    except:
                        continue
                
                if not all_articles:
                    return {
                        "status": "no_articles",
                        "news_score": 0,
                        "articles_count": 0,
                        "headlines": []
                    }
                
                # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø± Ø§Ù„Ø¨Ø³ÙŠØ·
                news_score = 0
                processed_articles = []
                seen_titles = set()
                
                for article in all_articles[:30]:  # Ø£ÙØ¶Ù„ 30 Ù…Ù‚Ø§Ù„
                    title = article.get('title', '').lower()
                    description = article.get('description', '') or ''
                    content = f"{title} {description.lower()}"
                    
                    # ØªØ¬Ù†Ø¨ Ø§Ù„Ù…ÙƒØ±Ø±
                    if title in seen_titles or len(title) < 10:
                        continue
                    seen_titles.add(title)
                    
                    # ÙØ­Øµ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© ÙˆØ§Ù„Ø³Ù„Ø¨ÙŠØ©
                    positive_count = sum(1 for word in positive_words if word in content)
                    negative_count = sum(1 for word in negative_words if word in content)
                    
                    # Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù‚Ø§Ù„
                    article_score = positive_count - negative_count
                    
                    # Ø¥Ø°Ø§ ÙŠØªØ­Ø¯Ø« Ø¹Ù† Ø§Ù„Ø°Ù‡Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©
                    if any(word in content for word in ['gold', 'xau', 'precious metal']):
                        article_score *= 1.5  # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ²Ù†
                        
                        news_score += article_score
                        
                        processed_articles.append({
                            'title': article.get('title', '')[:100],
                            'source': article.get('source', {}).get('name', 'Unknown'),
                            'score': round(article_score, 1),
                            'sentiment': 'positive' if article_score > 0 else 'negative' if article_score < 0 else 'neutral'
                        })
                
                # ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·
                if len(processed_articles) > 0:
                    avg_news_score = news_score / len(processed_articles)
                    news_score = max(-2, min(2, avg_news_score))  # Ø¨ÙŠÙ† -2 Ùˆ +2
                else:
                    news_score = 0
                
                return {
                    "status": "success",
                    "news_score": round(news_score, 2),
                    "articles_count": len(processed_articles),
                    "headlines": processed_articles[:8],  # Ø£ÙØ¶Ù„ 8 Ù…Ù‚Ø§Ù„Ø§Øª
                    "positive_articles": len([a for a in processed_articles if a['score'] > 0]),
                    "negative_articles": len([a for a in processed_articles if a['score'] < 0])
                }
                
            except Exception as e:
                return {
                    "status": "error",
                    "error": str(e),
                    "news_score": 0,
                    "articles_count": 0,
                    "headlines": []
                }
        
        def analyze_technical():
            """Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ"""
            try:
                # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                symbols = ['GLD', 'DX-Y.NYB', '^VIX', 'SPY']
                data = yf.download(symbols, period='6mo', progress=False)
                
                # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ù‡Ø¨
                gold = data[('Close', 'GLD')].dropna()
                
                # Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
                sma20 = gold.rolling(20).mean()
                sma50 = gold.rolling(50).mean()
                
                # RSI
                delta = gold.diff()
                gain = delta.where(delta > 0, 0).rolling(14).mean()
                loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
                rsi = 100 - (100 / (1 + gain / loss))
                
                # Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ©
                current_price = gold.iloc[-1]
                current_rsi = rsi.iloc[-1]
                current_sma20 = sma20.iloc[-1]
                current_sma50 = sma50.iloc[-1]
                
                # Ù†Ù‚Ø§Ø· ÙÙ†ÙŠØ©
                tech_score = 0
                if current_price > current_sma50: tech_score += 2
                if current_price > current_sma20: tech_score += 1.5
                if 30 < current_rsi < 70: tech_score += 1
                if current_sma20 > current_sma50: tech_score += 0.5
                
                tech_score = (tech_score / 5) * 2 - 1  # ØªØ·Ø¨ÙŠØ¹ Ø¨ÙŠÙ† -1 Ùˆ +1
                
                # Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ø§Ù…
                try:
                    vix = data[('Close', '^VIX')].iloc[-1]
                    dxy = data[('Close', 'DX-Y.NYB')].iloc[-1]
                except:
                    vix = dxy = 0
                
                return {
                    "status": "success",
                    "tech_score": round(tech_score, 3),
                    "gold_price": round(current_price, 2),
                    "rsi": round(current_rsi, 1),
                    "sma_20": round(current_sma20, 2),
                    "sma_50": round(current_sma50, 2),
                    "vix": round(vix, 1),
                    "dxy": round(dxy, 2),
                    "trend": "Bullish" if current_price > current_sma50 else "Bearish",
                    "data_points": len(gold)
                }
                
            except Exception as e:
                return {
                    "status": "error",
                    "error": str(e),
                    "tech_score": 0
                }
        
        def main():
            print("ðŸš€ Starting Gold Analysis with News...")
            
            # Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ
            print("ðŸ“ˆ Technical analysis...")
            tech_result = analyze_technical()
            
            # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
            print("ðŸ“° News analysis...")
            news_result = analyze_news()
            
            if tech_result['status'] == 'success':
                # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
                tech_score = tech_result['tech_score']
                news_score = news_result.get('news_score', 0)
                
                # Ø§Ù„Ø£ÙˆØ²Ø§Ù†: 70% ÙÙ†ÙŠØŒ 30% Ø£Ø®Ø¨Ø§Ø±
                total_score = (tech_score * 0.7) + (news_score * 0.3)
                
                # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
                if total_score >= 0.6:
                    signal = "Strong Buy"
                elif total_score >= 0.3:
                    signal = "Buy"  
                elif total_score >= -0.3:
                    signal = "Hold"
                elif total_score >= -0.6:
                    signal = "Sell"
                else:
                    signal = "Strong Sell"
                
                # Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                result = {
                    "timestamp": datetime.utcnow().isoformat(),
                    "status": "success",
                    
                    # Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
                    "signal": signal,
                    "total_score": round(total_score, 3),
                    "technical_score": tech_score,
                    "news_score": news_score,
                    
                    # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙ‚
                    "gold_price": tech_result['gold_price'],
                    "rsi": tech_result['rsi'], 
                    "sma_20": tech_result['sma_20'],
                    "sma_50": tech_result['sma_50'],
                    "vix": tech_result['vix'],
                    "dxy": tech_result['dxy'],
                    "trend": tech_result['trend'],
                    
                    # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
                    "news_analysis": {
                        "status": news_result['status'],
                        "articles_count": news_result.get('articles_count', 0),
                        "positive_articles": news_result.get('positive_articles', 0),
                        "negative_articles": news_result.get('negative_articles', 0),
                        "top_headlines": news_result.get('headlines', [])[:5]
                    },
                    
                    "data_points": tech_result['data_points']
                }
            else:
                result = {
                    "timestamp": datetime.utcnow().isoformat(),
                    "status": "error",
                    "error": tech_result.get('error', 'Technical analysis failed'),
                    "signal": "Hold",
                    "total_score": 0
                }
            
            # Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            with open('gold_analysis_complete.json', 'w', encoding='utf-8') as f:
                json.dump(result, f, ensure_ascii=False, indent=2)
            
            # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ø®Øµ
            print(f"âœ… Analysis Complete!")
            print(f"Signal: {result['signal']}")
            print(f"Total Score: {result.get('total_score', 0)}")
            
            if result['status'] == 'success':
                print(f"Gold Price: ${result['gold_price']}")
                print(f"Technical: {result['technical_score']:.3f}")
                print(f"News: {result['news_score']:.3f}")
                print(f"Articles: {result['news_analysis']['articles_count']}")
        
        if __name__ == "__main__":
            main()
        EOF

    - run: python full_analyzer.py

    - name: Display Complete Results
      run: |
        if [ -f "gold_analysis_complete.json" ]; then
          echo "âœ… Complete Analysis Done!"
          echo ""
          python -c "
        import json
        with open('gold_analysis_complete.json', 'r') as f:
            data = json.load(f)
        
        print(f'ðŸŽ¯ Signal: {data[\"signal\"]}')
        print(f'ðŸ“Š Total Score: {data.get(\"total_score\", 0):.3f}')
        print(f'ðŸ’° Gold Price: \${data.get(\"gold_price\", 0):,.2f}')
        print(f'ðŸ“ˆ Technical: {data.get(\"technical_score\", 0):.3f}')  
        print(f'ðŸ“° News: {data.get(\"news_score\", 0):.3f}')
        print(f'ðŸ“‹ Articles: {data.get(\"news_analysis\", {}).get(\"articles_count\", 0)}')
        print(f'âœ… Status: {data[\"status\"]}')
        
        headlines = data.get('news_analysis', {}).get('top_headlines', [])
        if headlines:
            print(f'\\nðŸ“° Top Headlines:')
            for i, h in enumerate(headlines[:3], 1):
                print(f'  {i}. {h[\"title\"]} [{h[\"source\"]}]')
          "
        else
          echo "âŒ No results file"
        fi

    - name: Commit Complete Results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Gold Analysis Bot ðŸ¤–"
        git add gold_analysis_complete.json
        
        SIGNAL=$(python -c "import json; print(json.load(open('gold_analysis_complete.json'))['signal'])" 2>/dev/null || echo 'Update')
        
        git commit -m "ðŸ¤– Gold Analysis: $SIGNAL - $(date -u '+%m/%d %H:%M UTC')" || echo "No changes"
        git push || echo "Push completed"

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: complete-gold-analysis
        path: gold_analysis_complete.json