name: Gold Analyzer V5 (GitHub Only)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * 1-5'  # Mon-Fri 21:00 UTC

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    env:
      FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Miniconda (with TA-Lib)
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.10"
          environment-file: environment.yml
          activate-environment: talib-env
          use-mamba: true

      - name: Sanitize gold_analyzer_v5.py (strip any leading non-Python)
        shell: bash -l {0}
        run: |
          awk 'BEGIN{keep=0}
               /^#!\/usr\/bin\/env python3|^from[[:space:]]|^import[[:space:]]/ {keep=1}
               {if(keep) print $0}' gold_analyzer_v5.py > gold_analyzer_v5.cleaned
          if [ -s gold_analyzer_v5.cleaned ]; then mv gold_analyzer_v5.cleaned gold_analyzer_v5.py; fi
          sed -n '1,40p' gold_analyzer_v5.py | cat

      - name: Run V5 Analyzer (daily, with compact)
        shell: bash -l {0}
        run: python gold_analyzer_v5.py --mode analyze --period 1y --compact

      - name: Commit JSON results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🏆 Update Gold Analysis V5"
          file_pattern: "gold_analysis_v5.json gold_analysis_v5_compact.json"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gold-analysis-v5
          path: |
            gold_analysis_v5.json
            gold_analysis_v5_compact.json

  backtest:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Miniconda (with TA-Lib)
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.10"
          environment-file: environment.yml
          activate-environment: talib-env
          use-mamba: true

      - name: Sanitize gold_analyzer_v5.py (strip any leading non-Python)
        shell: bash -l {0}
        run: |
          awk 'BEGIN{keep=0}
               /^#!\/usr\/bin\/env python3|^from[[:space:]]|^import[[:space:]]/ {keep=1}
               {if(keep) print $0}' gold_analyzer_v5.py > gold_analyzer_v5.cleaned
          if [ -s gold_analyzer_v5.cleaned ]; then mv gold_analyzer_v5.cleaned gold_analyzer_v5.py; fi

      - name: Run V5 Backtest (manual trigger)
        shell: bash -l {0}
        run: python gold_analyzer_v5.py --mode backtest --period 3y --adx-min 20 --rsi-buy 35 --rsi-sell 65 --atr-sl 2 --atr-tp 3

      - name: Commit Backtest results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "📈 Update Gold Backtest V5"
          file_pattern: "gold_backtest_v5.json"

      - name: Upload backtest artifact
        uses: actions/upload-artifact@v4
        with:
          name: gold-backtest-v5
          path: gold_backtest_v5.json
